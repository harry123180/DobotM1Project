<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus TCP Server ÁÆ°ÁêÜ‰ªãÈù¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .status-bar {
            background: #ecf0f1;
            padding: 20px;
            border-bottom: 2px solid #bdc3c7;
        }
        
        .status-item {
            display: inline-block;
            margin-right: 30px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .status-connected {
            color: #27ae60;
            font-weight: bold;
        }
        
        .status-disconnected {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        
        .register-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .register-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ecf0f1;
            transition: all 0.3s;
        }
        
        .register-item:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .register-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .register-value {
            font-size: 1.5em;
            color: #27ae60;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .register-comment {
            color: #7f8c8d;
            font-style: italic;
            margin-top: 10px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .input-group input {
            flex: 1;
        }
        
        .input-group .btn {
            margin: 0;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .col {
            flex: 1;
            min-width: 250px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pagination {
            text-align: center;
            margin: 30px 0;
        }
        
        .pagination button {
            margin: 0 5px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .row {
                flex-direction: column;
            }
            
            .register-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Modbus TCP Server ÁÆ°ÁêÜ‰ªãÈù¢</h1>
            <p>ÂØ¶ÊôÇÁõ£ÊéßÂíåÁÆ°ÁêÜÊÇ®ÁöÑModbus TCP‰º∫ÊúçÂô®</p>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <strong>UIÁãÄÊÖã:</strong> <span id="ui-status" class="status-connected">ÈÅãË°å‰∏≠</span>
            </div>
            <div class="status-item">
                <strong>‰º∫ÊúçÂô®ÈÄ£Êé•:</strong> <span id="server-connection" class="status-disconnected">Ê™¢Êü•‰∏≠...</span>
            </div>
            <div class="status-item">
                <strong>Slave ID:</strong> <span id="current-slave-id">-</span>
            </div>
            <div class="status-item">
                <strong>ÈÅãË°åÊôÇÈñì:</strong> <span id="uptime">-</span>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Á≥ªÁµ±Áµ±Ë®à -->
            <div class="section">
                <h2>üìä Á≥ªÁµ±Áµ±Ë®à</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-registers">1000</div>
                        <div class="stat-label">Á∏ΩÊö´Â≠òÂô®Êï∏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="non-zero-count">0</div>
                        <div class="stat-label">ÈùûÈõ∂Êö´Â≠òÂô®</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="modbus-port">502</div>
                        <div class="stat-label">Modbus Á´ØÂè£</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="api-port">8001</div>
                        <div class="stat-label">API Á´ØÂè£</div>
                    </div>
                </div>
            </div>
            
            <!-- ‰º∫ÊúçÂô®Ë®≠ÂÆö -->
            <div class="section">
                <h2>‚öôÔ∏è ‰º∫ÊúçÂô®Ë®≠ÂÆö</h2>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="slave-id-input">Slave ID (1-247):</label>
                            <div class="input-group">
                                <input type="number" id="slave-id-input" class="form-control" min="1" max="247" value="1">
                                <button class="btn btn-primary" onclick="updateSlaveId()">Êõ¥Êñ∞</button>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label>‰º∫ÊúçÂô®Êìç‰Ωú:</label>
                            <div>
                                <button class="btn btn-success" onclick="refreshStatus()">üîÑ ÈáçÊñ∞Êï¥ÁêÜÁãÄÊÖã</button>
                                <button class="btn btn-warning" onclick="clearAllRegisters()">üóëÔ∏è Ê∏ÖÁ©∫ÊâÄÊúâÊö´Â≠òÂô®</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÂñÆ‰∏ÄÊö´Â≠òÂô®Êìç‰Ωú -->
            <div class="section">
                <h2>üìù ÂñÆ‰∏ÄÊö´Â≠òÂô®Êìç‰Ωú</h2>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="single-address">Êö´Â≠òÂô®Âú∞ÂùÄ (0-999):</label>
                            <input type="number" id="single-address" class="form-control" min="0" max="999" value="0">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="single-value">Êï∏ÂÄº (0-65535):</label>
                            <div class="input-group">
                                <input type="number" id="single-value" class="form-control" min="0" max="65535" value="0">
                                <button class="btn btn-primary" onclick="writeRegister()">ÂØ´ÂÖ•</button>
                                <button class="btn btn-success" onclick="readRegister()">ËÆÄÂèñ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÊâπÈáèÊìç‰Ωú -->
            <div class="section">
                <h2>üìã ÊâπÈáèÊö´Â≠òÂô®Êìç‰Ωú</h2>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="batch-start">Ëµ∑ÂßãÂú∞ÂùÄ:</label>
                            <input type="number" id="batch-start" class="form-control" min="0" max="999" value="0">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="batch-values">Êï∏ÂÄºÂàóË°® (ÈÄóËôüÂàÜÈöî):</label>
                            <div class="input-group">
                                <input type="text" id="batch-values" class="form-control" placeholder="‰æãÂ¶Ç: 100,200,300">
                                <button class="btn btn-primary" onclick="writeBatchRegisters()">ÊâπÈáèÂØ´ÂÖ•</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Êö´Â≠òÂô®ÁÄèË¶Ω -->
            <div class="section">
                <h2>üîç Êö´Â≠òÂô®ÁÄèË¶Ω</h2>
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="view-start">Ëµ∑ÂßãÂú∞ÂùÄ:</label>
                            <input type="number" id="view-start" class="form-control" min="0" max="999" value="0">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="view-count">È°ØÁ§∫Êï∏Èáè:</label>
                            <div class="input-group">
                                <input type="number" id="view-count" class="form-control" min="1" max="100" value="20">
                                <button class="btn btn-primary" onclick="loadRegisterRange()">ËºâÂÖ•</button>
                                <button class="btn btn-success" onclick="loadNonZeroRegisters()">ÂÉÖÈ°ØÁ§∫ÈùûÈõ∂</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="pagination">
                    <button class="btn btn-primary" onclick="previousPage()">‚¨ÖÔ∏è ‰∏ä‰∏ÄÈ†Å</button>
                    <span id="page-info">Á¨¨ 1 È†Å</span>
                    <button class="btn btn-primary" onclick="nextPage()">‰∏ã‰∏ÄÈ†Å ‚û°Ô∏è</button>
                </div>
                
                <div id="register-list" class="register-grid">
                    <div class="loading">ËºâÂÖ•Êö´Â≠òÂô®Êï∏Êìö‰∏≠...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ê∂àÊÅØÊèêÁ§∫ÂçÄÂüü -->
    <div id="message-area" style="position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px;"></div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let currentPage = 0;
        let pageSize = 20;
        let totalRegisters = 1000;
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            checkServerConnection();
            loadRegisterRange();
            
            // ÂÆöÊúüÊ™¢Êü•ÈÄ£Êé•ÁãÄÊÖã
            setInterval(checkServerConnection, 5000);
        });
        
        // È°ØÁ§∫Ê∂àÊÅØ
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-warning';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert ${alertClass}`;
            messageDiv.textContent = message;
            messageDiv.style.marginBottom = '10px';
            
            messageArea.appendChild(messageDiv);
            
            // 3ÁßíÂæåËá™ÂãïÁßªÈô§
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }
        
        // Ê™¢Êü•‰º∫ÊúçÂô®ÈÄ£Êé•
        async function checkServerConnection() {
            try {
                const response = await fetch('/api/ui/status');
                const data = await response.json();
                
                // Êõ¥Êñ∞UIÁãÄÊÖã
                const serverConnection = document.getElementById('server-connection');
                if (data.server_connected) {
                    serverConnection.textContent = 'Â∑≤ÈÄ£Êé•';
                    serverConnection.className = 'status-connected';
                    
                    // Êõ¥Êñ∞‰º∫ÊúçÂô®‰ø°ÊÅØ
                    if (data.server_status) {
                        document.getElementById('current-slave-id').textContent = data.server_status.slave_id;
                        document.getElementById('total-registers').textContent = data.server_status.total_registers;
                        document.getElementById('non-zero-count').textContent = data.server_status.non_zero_count;
                        document.getElementById('modbus-port').textContent = data.server_status.modbus_port || 502;
                        document.getElementById('api-port').textContent = data.server_status.api_port || 8001;
                        document.getElementById('uptime').textContent = formatUptime(data.server_status.uptime);
                        document.getElementById('slave-id-input').value = data.server_status.slave_id;
                    }
                } else {
                    serverConnection.textContent = 'Êú™ÈÄ£Êé•';
                    serverConnection.className = 'status-disconnected';
                }
            } catch (error) {
                console.error('Ê™¢Êü•ÈÄ£Êé•Â§±Êïó:', error);
                const serverConnection = document.getElementById('server-connection');
                serverConnection.textContent = 'ÈÄ£Êé•ÈåØË™§';
                serverConnection.className = 'status-disconnected';
            }
        }
        
        // Ê†ºÂºèÂåñÈÅãË°åÊôÇÈñì
        function formatUptime(seconds) {
            if (!seconds) return '-';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            return `${hours}ÊôÇ${minutes}ÂàÜ${secs}Áßí`;
        }
        
        // Êõ¥Êñ∞Slave ID
        async function updateSlaveId() {
            const slaveId = parseInt(document.getElementById('slave-id-input').value);
            
            if (slaveId < 1 || slaveId > 247) {
                showMessage('Slave ID ÂøÖÈ†àÂú® 1-247 ÁØÑÂúçÂÖß', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/ui/slave_id', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ slave_id: slaveId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`Slave ID Â∑≤Êõ¥Êñ∞ÁÇ∫ ${data.slave_id}`, 'success');
                    document.getElementById('current-slave-id').textContent = data.slave_id;
                } else {
                    showMessage(data.error || 'Êõ¥Êñ∞ Slave ID Â§±Êïó', 'error');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ Slave ID Â§±Êïó:', error);
                showMessage('Êõ¥Êñ∞ Slave ID Â§±Êïó', 'error');
            }
        }
        
        // ÈáçÊñ∞Êï¥ÁêÜÁãÄÊÖã
        async function refreshStatus() {
            await checkServerConnection();
            showMessage('ÁãÄÊÖãÂ∑≤ÈáçÊñ∞Êï¥ÁêÜ', 'success');
        }
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÊö´Â≠òÂô®
        async function clearAllRegisters() {
            if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊö´Â≠òÂô®ÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                return;
            }
            
            try {
                const values = new Array(1000).fill(0);
                const response = await fetch('/api/ui/registers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        start_address: 0, 
                        values: values 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('ÊâÄÊúâÊö´Â≠òÂô®Â∑≤Ê∏ÖÁ©∫', 'success');
                    loadRegisterRange();
                } else {
                    showMessage(data.error || 'Ê∏ÖÁ©∫Êö´Â≠òÂô®Â§±Êïó', 'error');
                }
            } catch (error) {
                console.error('Ê∏ÖÁ©∫Êö´Â≠òÂô®Â§±Êïó:', error);
                showMessage('Ê∏ÖÁ©∫Êö´Â≠òÂô®Â§±Êïó', 'error');
            }
        }
        
        // ËÆÄÂèñÂñÆ‰∏ÄÊö´Â≠òÂô®
        async function readRegister() {
            const address = parseInt(document.getElementById('single-address').value);
            
            if (address < 0 || address > 999) {
                showMessage('Âú∞ÂùÄÂøÖÈ†àÂú® 0-999 ÁØÑÂúçÂÖß', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/ui/register/${address}`);
                const data = await response.json();
                
                if (data.address !== undefined) {
                    document.getElementById('single-value').value = data.value;
                    showMessage(`Âú∞ÂùÄ ${address} ÁöÑÂÄºÁÇ∫ ${data.value}`, 'success');
                } else {
                    showMessage(data.error || 'ËÆÄÂèñÊö´Â≠òÂô®Â§±Êïó', 'error');
                }
            } catch (error) {
                console.error('ËÆÄÂèñÊö´Â≠òÂô®Â§±Êïó:', error);
                showMessage('ËÆÄÂèñÊö´Â≠òÂô®Â§±Êïó', 'error');
            }
        }
        
        // ÂØ´ÂÖ•ÂñÆ‰∏ÄÊö´Â≠òÂô®
        async function writeRegister() {
            const address = parseInt(document.getElementById('single-address').value);
            const value = parseInt(document.getElementById('single-value').value);
            
            if (address < 0 || address > 999) {
                showMessage('Âú∞ÂùÄÂøÖÈ†àÂú® 0-999 ÁØÑÂúçÂÖß', 'error');
                return;
            }
            
            if (value < 0 || value > 65535) {
                showMessage('Êï∏ÂÄºÂøÖÈ†àÂú® 0-65535 ÁØÑÂúçÂÖß', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/ui/register/${address}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ value: value })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`Âú∞ÂùÄ ${address} Â∑≤Ë®≠ÁÇ∫ ${value}`, 'success');
                    // Â¶ÇÊûúÁï∂ÂâçÈ°ØÁ§∫ÁØÑÂúçÂåÖÂê´Ê≠§Âú∞ÂùÄÔºåÊõ¥Êñ∞È°ØÁ§∫
                    const currentStart = currentPage * pageSize;
                    if (address >= currentStart && address < currentStart + pageSize) {
                        loadRegisterRange();
                    }
                } else {
                    showMessage(data.error || 'ÂØ´ÂÖ•Êö´Â≠òÂô®Â§±Êïó', 'error');
                }
            } catch (error) {
                console.error('ÂØ´ÂÖ•Êö´Â≠òÂô®Â§±Êïó:', error);
                showMessage('ÂØ´ÂÖ•Êö´Â≠òÂô®Â§±Êïó', 'error');
            }
        }
        
        // ÊâπÈáèÂØ´ÂÖ•Êö´Â≠òÂô®
        async function writeBatchRegisters() {
            const startAddress = parseInt(document.getElementById('batch-start').value);
            const valuesText = document.getElementById('batch-values').value.trim();
            
            if (startAddress < 0 || startAddress > 999) {
                showMessage('Ëµ∑ÂßãÂú∞ÂùÄÂøÖÈ†àÂú® 0-999 ÁØÑÂúçÂÖß', 'error');
                return;
            }
            
            if (!valuesText) {
                showMessage('Ë´ãËº∏ÂÖ•Êï∏ÂÄºÂàóË°®', 'error');
                return;
            }
            
            try {
                const values = valuesText.split(',').map(v => {
                    const num = parseInt(v.trim());
                    if (isNaN(num) || num < 0 || num > 65535) {
                        throw new Error(`ÁÑ°ÊïàÁöÑÊï∏ÂÄº: ${v.trim()}`);
                    }
                    return num;
                });
                
                if (startAddress + values.length > 1000) {
                    showMessage('ÊâπÈáèÂØ´ÂÖ•Ë∂ÖÂá∫Êö´Â≠òÂô®ÁØÑÂúç', 'error');
                    return;
                }
                
                const response = await fetch('/api/ui/registers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        start_address: startAddress, 
                        values: values 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`ÊàêÂäüÂØ´ÂÖ• ${values.length} ÂÄãÊö´Â≠òÂô®`, 'success');
                    loadRegisterRange();
                } else {
                    showMessage(data.error || 'ÊâπÈáèÂØ´ÂÖ•Â§±Êïó', 'error');
                }
            } catch (error) {
                console.error('ÊâπÈáèÂØ´ÂÖ•Â§±Êïó:', error);
                showMessage(error.message || 'ÊâπÈáèÂØ´ÂÖ•Â§±Êïó', 'error');
            }
        }
        
        // ËºâÂÖ•Êö´Â≠òÂô®ÁØÑÂúç
        async function loadRegisterRange() {
            const startAddress = currentPage * pageSize;
            const count = parseInt(document.getElementById('view-count').value) || pageSize;
            
            try {
                const response = await fetch(`/api/ui/register_range?start=${startAddress}&count=${count}`);
                const data = await response.json();
                
                if (data.success) {
                    displayRegisters(data.registers);
                    updatePageInfo();
                } else {
                    showMessage(data.error || 'ËºâÂÖ•Êö´Â≠òÂô®Â§±Êïó', 'error');
                }
            } catch (error) {
                console.error('ËºâÂÖ•Êö´Â≠òÂô®Â§±Êïó:', error);
                showMessage('ËºâÂÖ•Êö´Â≠òÂô®Â§±Êïó', 'error');
            }
        }
        
        // ËºâÂÖ•ÈùûÈõ∂Êö´Â≠òÂô®
        async function loadNonZeroRegisters() {
            try {
                const response = await fetch('/api/ui/status');
                const data = await response.json();
                
                if (data.server_status && data.server_status.non_zero_registers) {
                    const nonZeroRegs = [];
                    for (const [address, value] of Object.entries(data.server_status.non_zero_registers)) {
                        // Áç≤ÂèñË®ªËß£
                        try {
                            const regResponse = await fetch(`/api/ui/register/${address}`);
                            const regData = await regResponse.json();
                            nonZeroRegs.push({
                                address: parseInt(address),
                                value: value,
                                comment: regData.comment || ''
                            });
                        } catch (e) {
                            nonZeroRegs.push({
                                address: parseInt(address),
                                value: value,
                                comment: ''
                            });
                        }
                    }
                    
                    displayRegisters(nonZeroRegs);
                    document.getElementById('page-info').textContent = `È°ØÁ§∫ ${nonZeroRegs.length} ÂÄãÈùûÈõ∂Êö´Â≠òÂô®`;
                } else {
                    showMessage('ÁÑ°Ê≥ïÁç≤ÂèñÈùûÈõ∂Êö´Â≠òÂô®Êï∏Êìö', 'error');
                }
            } catch (error) {
                console.error('ËºâÂÖ•ÈùûÈõ∂Êö´Â≠òÂô®Â§±Êïó:', error);
                showMessage('ËºâÂÖ•ÈùûÈõ∂Êö´Â≠òÂô®Â§±Êïó', 'error');
            }
        }
        
        // È°ØÁ§∫Êö´Â≠òÂô®
        function displayRegisters(registers) {
            const registerList = document.getElementById('register-list');
            
            if (!registers || registers.length === 0) {
                registerList.innerHTML = '<div class="loading">Êö´ÁÑ°Êö´Â≠òÂô®Êï∏Êìö</div>';
                return;
            }
            
            registerList.innerHTML = registers.map(reg => `
                <div class="register-item">
                    <div class="register-header">Êö´Â≠òÂô® ${reg.address}</div>
                    <div class="register-value">${reg.value}</div>
                    <div class="register-comment">${reg.comment || 'ÁÑ°Ë®ªËß£'}</div>
                    <div class="input-group">
                        <input type="number" 
                               class="form-control" 
                               id="reg-${reg.address}" 
                               value="${reg.value}" 
                               min="0" max="65535"
                               placeholder="Êñ∞Êï∏ÂÄº">
                        <button class="btn btn-primary" onclick="updateRegister(${reg.address})">Êõ¥Êñ∞</button>
                    </div>
                    <div class="input-group" style="margin-top: 10px;">
                        <input type="text" 
                               class="form-control" 
                               id="comment-${reg.address}" 
                               value="${reg.comment || ''}" 
                               placeholder="Ë®ªËß£">
                        <button class="btn btn-success" onclick="updateComment(${reg.address})">Êõ¥Êñ∞Ë®ªËß£</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Êõ¥Êñ∞Êö´Â≠òÂô®
        async function updateRegister(address) {
            const value = parseInt(document.getElementById(`reg-${address}`).value);
            
            if (isNaN(value) || value < 0 || value > 65535) {
                showMessage('Êï∏ÂÄºÂøÖÈ†àÂú® 0-65535 ÁØÑÂúçÂÖß', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/ui/register/${address}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ value: value })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`Êö´Â≠òÂô® ${address} Â∑≤Êõ¥Êñ∞ÁÇ∫ ${value}`, 'success');
                    loadRegisterRange();
                } else {
                    showMessage(data.error || 'Êõ¥Êñ∞Êö´Â≠òÂô®Â§±Êïó', 'error');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Êö´Â≠òÂô®Â§±Êïó:', error);
                showMessage('Êõ¥Êñ∞Êö´Â≠òÂô®Â§±Êïó', 'error');
            }
        }
        
        // Êõ¥Êñ∞Ë®ªËß£
        async function updateComment(address) {
            const comment = document.getElementById(`comment-${address}`).value;
            
            try {
                const response = await fetch(`/api/ui/comment/${address}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ comment: comment })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`Êö´Â≠òÂô® ${address} Ë®ªËß£Â∑≤Êõ¥Êñ∞`, 'success');
                } else {
                    showMessage(data.error || 'Êõ¥Êñ∞Ë®ªËß£Â§±Êïó', 'error');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Ë®ªËß£Â§±Êïó:', error);
                showMessage('Êõ¥Êñ∞Ë®ªËß£Â§±Êïó', 'error');
            }
        }
        
        // ‰∏ä‰∏ÄÈ†Å
        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                loadRegisterRange();
            }
        }
        
        // ‰∏ã‰∏ÄÈ†Å
        function nextPage() {
            const maxPage = Math.floor((totalRegisters - 1) / pageSize);
            if (currentPage < maxPage) {
                currentPage++;
                loadRegisterRange();
            }
        }
        
        // Êõ¥Êñ∞È†ÅÈù¢‰ø°ÊÅØ
        function updatePageInfo() {
            const startAddr = currentPage * pageSize;
            const endAddr = Math.min(startAddr + pageSize - 1, totalRegisters - 1);
            const totalPages = Math.ceil(totalRegisters / pageSize);
            document.getElementById('page-info').textContent = 
                `Á¨¨ ${currentPage + 1}/${totalPages} È†Å (Âú∞ÂùÄ ${startAddr}-${endAddr})`;
        }
        
        // Êõ¥Êñ∞È°ØÁ§∫ÁØÑÂúç
        function updateViewRange() {
            const startAddress = parseInt(document.getElementById('view-start').value);
            const count = parseInt(document.getElementById('view-count').value);
            
            if (startAddress >= 0 && startAddress < totalRegisters) {
                currentPage = Math.floor(startAddress / pageSize);
                pageSize = Math.min(count, 100);
                loadRegisterRange();
            }
        }
        
        // Á∂ÅÂÆöÂõûËªäÈçµ‰∫ã‰ª∂
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const target = e.target;
                if (target.id === 'slave-id-input') {
                    updateSlaveId();
                } else if (target.id === 'single-address' || target.id === 'single-value') {
                    writeRegister();
                } else if (target.id === 'batch-start' || target.id === 'batch-values') {
                    writeBatchRegisters();
                } else if (target.id === 'view-start' || target.id === 'view-count') {
                    updateViewRange();
                }
            }
        });
    </script>
</body>
</html>