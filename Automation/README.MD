# ä¿®æ­£å¾Œçš„è‡ªå‹•åŒ–ç”Ÿç”¢ç·šç³»çµ±æ¶æ§‹

## ğŸ—ï¸ å¯¦éš›ç¡¬é«”æ¶æ§‹æ•´åˆ

### æ•´é«”æ¶æ§‹åœ–
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                CASE å…¥æ–™æ©Ÿ PC (192.168.1.5)                â”‚
â”‚                    ä»»å‹™èª¿åº¦å™¨ + ç›£æ§                         â”‚
â”‚                                                             â”‚
â”‚  â”œâ”€â”€ USB Port 1 (RS485ç¸½ç·š)                                â”‚
â”‚  â”‚   â”œâ”€â”€ å‡é™ç¼¸ (Slave 2)                                  â”‚
â”‚  â”‚   â”œâ”€â”€ æ—‹è½‰ç¼¸ (Slave 3)                                  â”‚
â”‚  â”‚   â”œâ”€â”€ ç¿»è½‰å¤¾çˆª (Slave 4)                                â”‚
â”‚  â”‚   â”œâ”€â”€ è¼¸é€å¸¶é™ä½é›»ç¼¸ (Slave 5)                          â”‚
â”‚  â”‚   â””â”€â”€ æ©Ÿæ¢°è‡‚å¤¾çˆª (Slave 6)                              â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€â”€ USB Port 2 (RS232)                                    â”‚
â”‚  â”‚   â””â”€â”€ æ–°äºæ´²å…‰æºæ§åˆ¶å™¨                                   â”‚
â”‚  â”‚       â”œâ”€â”€ Light 1 (è¼¸é€å¸¶ç›¸æ©Ÿ)                          â”‚
â”‚  â”‚       â”œâ”€â”€ Light 2 (æ—‹è½‰æ­£ä¸Šæ–¹ç›¸æ©Ÿ)                      â”‚
â”‚  â”‚       â””â”€â”€ Light 3 (æ—‹è½‰å´é‚Šç›¸æ©Ÿ)                        â”‚
â”‚  â”‚                                                         â”‚
â”‚  â””â”€â”€ EtherCATè»¸å¡                                          â”‚
â”‚      â”œâ”€â”€ è¼¸å…¥æ¨¡çµ„ (X00~X06)                                â”‚
â”‚      â””â”€â”€ TOYOæ»‘å°é©…å‹•å™¨                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ POE 8 Port Switch
                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚                 â”‚
    â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚M1 Pro   â”‚    â”‚æŸ”æ€§æŒ¯å‹•ç›¤    â”‚    â”‚ç›¸æ©Ÿç¾¤çµ„      â”‚
â”‚æ©Ÿæ¢°è‡‚    â”‚    â”‚192.168.1.7  â”‚    â”‚CCD1~CCD4    â”‚
â”‚192.168.1.6â”‚  â”‚            â”‚    â”‚.8/.9/.10/.11â”‚
â”‚         â”‚    â”‚            â”‚    â”‚             â”‚
â”‚IOæ§åˆ¶:   â”‚    â”‚            â”‚    â”‚             â”‚
â”‚DI 9~15  â”‚    â”‚            â”‚    â”‚             â”‚
â”‚DO 1~5   â”‚    â”‚            â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ä¿®æ­£å¾Œçš„ç¯€é»æ¶æ§‹

### 1. ä¸»æ§åˆ¶ç¯€é» (CASEå…¥æ–™æ©ŸPC)
```python
# scheduler/master_controller.py
class MasterController:
    """ä¸»æ§åˆ¶å™¨ï¼šçµ±ä¸€ä»»å‹™èª¿åº¦å’Œè¨­å‚™å”èª¿"""
    
    def __init__(self):
        # ç¶²è·¯è¨­å‚™å®¢æˆ¶ç«¯
        self.robot_arm_client = RobotArmClient("192.168.1.6")
        self.vibration_bowl_client = VibrationBowlClient("192.168.1.7")
        self.vision_clients = {
            'ccd1': VisionClient("192.168.1.8"),   # æŸ”æŒ¯ç›¸æ©Ÿ
            'ccd2': VisionClient("192.168.1.9"),   # è¼¸é€å¸¶ç›¸æ©Ÿ
            'ccd3': VisionClient("192.168.1.10"),  # æ—‹è½‰æ­£ä¸Šæ–¹
            'ccd4': VisionClient("192.168.1.11")   # æ—‹è½‰å´é‚Š
        }
        
        # æœ¬åœ°USBè¨­å‚™æ§åˆ¶å™¨
        self.rs485_controller = RS485Controller("/dev/ttyUSB0")  # USB Port 1
        self.rs232_light_controller = RS232Controller("/dev/ttyUSB1")  # USB Port 2
        self.ethercat_controller = EtherCATController("eth0")
        
        self.mqtt_client = MQTTClient()
        
    async def coordinate_production_cycle(self):
        """å”èª¿å®Œæ•´ç”Ÿç”¢é€±æœŸ"""
        # 1. æŸ”æ€§æŒ¯å‹•ç›¤é€æ–™
        await self.vibration_bowl_client.start_feeding()
        
        # 2. é–‹å•Ÿå…‰æºä¸¦é€²è¡ŒCCD1 è¦–è¦ºæª¢æ¸¬
        await self.rs232_light_controller.turn_on_light(1)  # æœ¬åœ°æ§åˆ¶å…‰æº
        parts_info = await self.vision_clients['ccd1'].detect_parts()
        
        # 3. æ©Ÿæ¢°è‡‚å–æ–™ (é€éç¶²è·¯æ§åˆ¶æ©Ÿæ¢°è‡‚æœ¬é«”)
        await self.robot_arm_client.move_to_pick(parts_info.position)
        
        # 4. æ§åˆ¶å¤¾çˆªå¤¾å– (é€éæœ¬åœ°RS485)
        await self.rs485_controller.control_gripper(6, "close")  # Slave 6
        
        # 5. å¾ŒçºŒæµç¨‹...
```

### 2. æ©Ÿæ¢°è‡‚ç¯€é» (M1 Proæ©Ÿæ¢°è‡‚PC)
```python
# nodes/robot_arm_node.py
class RobotArmNode(BaseNode):
    """æ©Ÿæ¢°è‡‚ç¯€é»ï¼šåªæ§åˆ¶æ©Ÿæ¢°è‡‚æœ¬é«”é‹å‹•å’ŒIOè®€å¯«"""
    
    def __init__(self):
        super().__init__()
        self.robot_arm = M1ProController()  # æ©Ÿæ¢°è‡‚æœ¬é«”æ§åˆ¶
        self.io_controller = IOController()  # æœ¬åœ°IOæ§åˆ¶ (DI/DO)
        
    def setup_hardware(self):
        """åˆå§‹åŒ–æ©Ÿæ¢°è‡‚ç¡¬é«”"""
        # æ©Ÿæ¢°è‡‚åˆå§‹åŒ–
        self.robot_arm.initialize()
        
        # IOé…ç½®
        self.digital_inputs = {
            9: "æ–æ–æ¡¶å·¦ä¸Šæ„Ÿæ¸¬å™¨",
            10: "æ–æ–æ¡¶å·¦ä¸‹æ„Ÿæ¸¬å™¨", 
            11: "æ–æ–æ¡¶å³ä¸Šæ„Ÿæ¸¬å™¨",
            12: "æ–æ–æ¡¶å³ä¸‹æ„Ÿæ¸¬å™¨",
            13: "åˆ°ä½æ„Ÿæ¸¬å™¨",
            14: "ç¿»è½‰0åº¦æ„Ÿæ¸¬å™¨",
            15: "ç¿»è½‰180åº¦æ„Ÿæ¸¬å™¨"
        }
        
        self.digital_outputs = {
            1: "æ–æ–æ¡¶5/2é›»ç£é–¥",
            2: "è¼¸é€å¸¶é©…å‹•IO",
            3: "NGæ°£æ§5/2é›»ç£é–¥", 
            4: "ç›´æŒ¯é–‹é—œ",
            5: "ç¿»è½‰æ°£ç¼¸5/2é›»ç£é–¥"
        }
        
    async def process_task(self, task):
        """è™•ç†ä»»å‹™è«‹æ±‚"""
        if task.type == "MOVE_TO_POSITION":
            await self._move_to_position(task.position)
        elif task.type == "READ_SENSORS":
            return await self._read_all_sensors()
        elif task.type == "CONTROL_OUTPUT":
            await self._control_output(task.output_id, task.state)
            
    async def _move_to_position(self, position):
        """ç§»å‹•åˆ°æŒ‡å®šä½ç½®"""
        await self.robot_arm.move_to_position(position)
        await self.publish_status("POSITION_REACHED", position)
        
    async def _read_all_sensors(self):
        """è®€å–æ‰€æœ‰æ„Ÿæ¸¬å™¨ç‹€æ…‹"""
        sensor_status = {}
        for pin, description in self.digital_inputs.items():
            sensor_status[pin] = self.io_controller.read_digital_input(pin)
        return sensor_status
        
    async def _control_output(self, output_id, state):
        """æ§åˆ¶æ•¸ä½è¼¸å‡º"""
        self.io_controller.write_digital_output(output_id, state)
        await self.publish_status("OUTPUT_CONTROLLED", {
            "output_id": output_id, 
            "state": state
        })
```

### 3. CASEå…¥æ–™æ©ŸPCçš„è¨­å‚™æ§åˆ¶æ¨¡çµ„
```python
# hardware/local_device_controller.py
class LocalDeviceController:
    """CASEå…¥æ–™æ©ŸPCæœ¬åœ°è¨­å‚™æ§åˆ¶å™¨"""
    
    def __init__(self):
        # USBè¨­å‚™æ§åˆ¶å™¨
        self.rs485_controller = RS485Controller("/dev/ttyUSB0")
        self.rs232_light_controller = RS232LightController("/dev/ttyUSB1") 
        self.ethercat_controller = EtherCATController("eth0")
        
        # è¨­å‚™æ˜ å°„
        self.rs485_devices = {
            'lift_cylinder': 2,      # å‡é™ç¼¸ Slave 2
            'rotation_cylinder': 3,  # æ—‹è½‰ç¼¸ Slave 3
            'flip_gripper': 4,      # ç¿»è½‰å¤¾çˆª Slave 4
            'conveyor_limit': 5,    # è¼¸é€å¸¶é™ä½é›»ç¼¸ Slave 5
            'robot_gripper': 6      # æ©Ÿæ¢°è‡‚å¤¾çˆª Slave 6
        }
        
        self.light_channels = {
            'conveyor_camera': 1,    # Light 1 è¼¸é€å¸¶ç›¸æ©Ÿ
            'rotation_top': 2,       # Light 2 æ—‹è½‰æ­£ä¸Šæ–¹ç›¸æ©Ÿ
            'rotation_side': 3       # Light 3 æ—‹è½‰å´é‚Šç›¸æ©Ÿ
        }
        
    async def control_rs485_device(self, device_name: str, command: dict):
        """æ§åˆ¶RS485è¨­å‚™"""
        if device_name not in self.rs485_devices:
            raise ValueError(f"Unknown RS485 device: {device_name}")
            
        slave_id = self.rs485_devices[device_name]
        return await self.rs485_controller.send_command(slave_id, command)
        
    async def control_light(self, light_name: str, action: str, brightness: int = 100):
        """æ§åˆ¶å…‰æº"""
        if light_name not in self.light_channels:
            raise ValueError(f"Unknown light: {light_name}")
            
        channel = self.light_channels[light_name]
        
        if action == "on":
            await self.rs232_light_controller.turn_on(channel, brightness)
        elif action == "off":
            await self.rs232_light_controller.turn_off(channel)
        else:
            raise ValueError(f"Invalid light action: {action}")
            
    async def read_ethercat_inputs(self):
        """è®€å–EtherCATè¼¸å…¥"""
        inputs = {}
        input_map = {
            'X00': 'Door1',
            'X01': 'Door2', 
            'X03': 'Door3',
            'X04': 'TOYOå·¦',
            'X05': 'TOYODog',
            'X06': 'TOYOå³'
        }
        
        for address, description in input_map.items():
            inputs[description] = await self.ethercat_controller.read_input(address)
            
        return inputs
        
    async def control_toyo_slider(self, position: float, speed: float = 100):
        """æ§åˆ¶TOYOæ»‘å°"""
        await self.ethercat_controller.move_axis(
            axis_id=1, 
            position=position, 
            speed=speed
        )
```

## ğŸ”§ MQTT ä¸»é¡Œé‡æ–°è¨­è¨ˆ

```python
# communication/topics.py
MQTT_TOPICS = {
    # ä¸»æ§åˆ¶ç›¸é—œ
    "master_control": {
        "task_assignment": "automation/master/tasks/assign",
        "coordination": "automation/master/coordinate",
        "system_status": "automation/master/status"
    },
    
    # æ©Ÿæ¢°è‡‚æ•´åˆç¯€é»
    "robot_integrated": {
        "status": "automation/robot/status",
        "control": "automation/robot/control",
        "io_status": "automation/robot/io/status",
        "rs485_control": "automation/robot/rs485/control",
        "lighting_control": "automation/robot/lighting/control"
    },
    
    # è¦–è¦ºç¯€é»ç¾¤çµ„
    "vision": {
        "ccd1_results": "automation/vision/ccd1/results",
        "ccd2_results": "automation/vision/ccd2/results", 
        "ccd3_results": "automation/vision/ccd3/results",
        "ccd4_results": "automation/vision/ccd4/results",
        "lighting_request": "automation/lighting/request"
    },
    
    # æŸ”æ€§æŒ¯å‹•ç›¤
    "vibration_bowl": {
        "control": "automation/vibration_bowl/control",
        "status": "automation/vibration_bowl/status"
    }
}
```

## ğŸ“ èª¿æ•´å¾Œçš„å°ˆæ¡ˆçµæ§‹

```
automation_system/
â”œâ”€â”€ master_controller/           # ä¸»æ§åˆ¶å™¨ (CASEå…¥æ–™æ©ŸPC)
â”‚   â”œâ”€â”€ task_scheduler.py       # ä»»å‹™èª¿åº¦å™¨
â”‚   â”œâ”€â”€ production_coordinator.py # ç”Ÿç”¢å”èª¿å™¨
â”‚   â””â”€â”€ system_monitor.py       # ç³»çµ±ç›£æ§
â”œâ”€â”€ nodes/
â”‚   â”œâ”€â”€ integrated_robot_node.py # æ•´åˆå¼æ©Ÿæ¢°è‡‚ç¯€é»
â”‚   â”œâ”€â”€ vision_node.py          # è¦–è¦ºç¯€é»æ¨¡æ¿
â”‚   â”œâ”€â”€ vibration_bowl_node.py  # æŸ”æ€§æŒ¯å‹•ç›¤ç¯€é»
â”‚   â””â”€â”€ camera_nodes/           # å„ç›¸æ©Ÿç¯€é»
â”‚       â”œâ”€â”€ ccd1_node.py        # æŸ”æŒ¯ç›¸æ©Ÿ
â”‚       â”œâ”€â”€ ccd2_node.py        # è¼¸é€å¸¶ç›¸æ©Ÿ  
â”‚       â”œâ”€â”€ ccd3_node.py        # æ—‹è½‰æ­£ä¸Šæ–¹ç›¸æ©Ÿ
â”‚       â””â”€â”€ ccd4_node.py        # æ—‹è½‰å´é‚Šç›¸æ©Ÿ
â”œâ”€â”€ hardware/                   # ç¡¬é«”æ§åˆ¶å±¤
â”‚   â”œâ”€â”€ robot_controller.py     # M1 Proæ©Ÿæ¢°è‡‚æ§åˆ¶
â”‚   â”œâ”€â”€ io_controller.py        # IOæ§åˆ¶
â”‚   â”œâ”€â”€ rs485_controller.py     # RS485ç¸½ç·šæ§åˆ¶
â”‚   â”œâ”€â”€ rs232_controller.py     # RS232è¨­å‚™æ§åˆ¶
â”‚   â””â”€â”€ ethercat_controller.py  # EtherCATè»¸å¡æ§åˆ¶
â””â”€â”€ protocols/                  # é€šè¨Šå”è­°
    â”œâ”€â”€ modbus_protocol.py      # Modbuså”è­°
    â”œâ”€â”€ ethercat_protocol.py    # EtherCATå”è­°
    â””â”€â”€ camera_protocol.py     # ç›¸æ©Ÿé€šè¨Šå”è­°
```

## ğŸš€ éƒ¨ç½²é…ç½®

### ä¸»æ§åˆ¶å™¨é…ç½® (CASEå…¥æ–™æ©ŸPC - 192.168.1.5)
```json
{
    "master_controller": {
        "ip": "192.168.1.5",
        "mqtt_broker_port": 1883,
        "web_dashboard_port": 8080,
        "coordination_interval": 0.1
    },
    "local_hardware": {
        "rs485_port": "/dev/ttyUSB0",
        "rs232_port": "/dev/ttyUSB1", 
        "ethercat_interface": "eth0",
        "rs485_devices": {
            "lift_cylinder": 2,
            "rotation_cylinder": 3,
            "flip_gripper": 4,
            "conveyor_limit": 5,
            "robot_gripper": 6
        },
        "light_channels": {
            "conveyor_camera": 1,
            "rotation_top": 2,
            "rotation_side": 3
        }
    },
    "network_nodes": {
        "robot_arm": "192.168.1.6",
        "vibration_bowl": "192.168.1.7",
        "cameras": {
            "ccd1": "192.168.1.8",
            "ccd2": "192.168.1.9", 
            "ccd3": "192.168.1.10",
            "ccd4": "192.168.1.11"
        }
    }
}
```

### æ©Ÿæ¢°è‡‚ç¯€é»é…ç½® (M1 Pro - 192.168.1.6)
```json
{
    "robot_arm": {
        "ip": "192.168.1.6",
        "web_port": 5003,
        "hardware": {
            "robot_type": "M1_Pro",
            "io_configuration": {
                "digital_inputs": {
                    "9": "æ–æ–æ¡¶å·¦ä¸Šæ„Ÿæ¸¬å™¨",
                    "10": "æ–æ–æ¡¶å·¦ä¸‹æ„Ÿæ¸¬å™¨",
                    "11": "æ–æ–æ¡¶å³ä¸Šæ„Ÿæ¸¬å™¨", 
                    "12": "æ–æ–æ¡¶å³ä¸‹æ„Ÿæ¸¬å™¨",
                    "13": "åˆ°ä½æ„Ÿæ¸¬å™¨",
                    "14": "ç¿»è½‰0åº¦æ„Ÿæ¸¬å™¨",
                    "15": "ç¿»è½‰180åº¦æ„Ÿæ¸¬å™¨"
                },
                "digital_outputs": {
                    "1": "æ–æ–æ¡¶5/2é›»ç£é–¥",
                    "2": "è¼¸é€å¸¶é©…å‹•IO",
                    "3": "NGæ°£æ§5/2é›»ç£é–¥",
                    "4": "ç›´æŒ¯é–‹é—œ", 
                    "5": "ç¿»è½‰æ°£ç¼¸5/2é›»ç£é–¥"
                }
            }
        },
        "capabilities": [
            "robot_movement",
            "io_control",
            "sensor_reading"
        ]
    }
}
```

é€™æ¨£çš„æ¶æ§‹èª¿æ•´æ›´ç¬¦åˆæ‚¨çš„å¯¦éš›ç¡¬é«”é…ç½®ï¼Œé¿å…äº†æ§åˆ¶æ¬Šè¡çªï¼ŒåŒæ™‚ä¿æŒäº†ç³»çµ±çš„æ¨¡çµ„åŒ–å’Œæ“´å±•æ€§ã€‚