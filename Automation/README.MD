# Modbus狀態機交握地址總表

## 系統架構
主服務器 (ModbusTCP:502) 統一管理所有模組，各模組基地址不重疊。

## 模組基地址分配
| 模組 | 基地址 | 狀態區 | 指令區 | 通訊協議 | 端口 |
|------|--------|--------|--------|----------|------|
| CCD視覺檢測 | 200 | 200-219 | 200-201(握手) | TCP Client + 相機直連 | - |
| VP震動盤 | 300 | 300-314 | 320-324 | TCP → TCP橋接 | 192.168.1.7:1000 |
| 機械臂(規劃) | 400 | 400-449 | - | 待實現 | - |
| Gripper夾爪 | 500 | 500-589 | - | RTU轉TCP橋接 | COM5(三款夾爪) |
| LED控制器 | 600 | 600-615 | 620-624 | RS232轉TCP橋接 | COM6 |
| **CCD3角度辨識** | **800** | **800-819** | **800-801(握手)** | **TCP Client + 相機直連** | **192.168.1.10** |
| XC100升降 | 1000 | 1000-1014 | 1020-1024 | RTU轉TCP橋接 | COM5 |

## CCD3角度辨識模組 (基地址800) - 新增

### 握手控制寄存器 (800-801)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 800 | 控制指令 | 0=清空, 8=拍照, 16=拍照+角度檢測, 32=重新初始化 |
| 801 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized |

### 檢測參數設定 (810-819)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 810 | 檢測模式 | 0=橢圓擬合模式, 1=最小外接矩形模式 | 透過寄存器選擇檢測模式 |
| 811 | 最小面積比例 | 乘以1000存儲 | 0.05 → 50 |
| 812 | 序列模式 | 0=最大輪廓, 1=序列輪廓 | 輪廓選擇方式 |
| 813 | 高斯模糊核大小 | 奇數值 | 3, 5, 7, 9等 |
| 814 | 閾值處理模式 | 0=OTSU自動, 1=手動 | 二值化處理方式 |
| 815 | 手動閾值 | 0-255 | 手動模式使用 |
| 816-819 | 保留參數 | - | 未來擴展使用 |

### 角度檢測結果 (840-859)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 840 | 檢測成功標誌 | 0=失敗, 1=成功 | 檢測結果有效性 |
| 841 | 物體中心X座標 | 像素座標 | 檢測物體中心位置 |
| 842 | 物體中心Y座標 | 像素座標 | 檢測物體中心位置 |
| 843 | 檢測角度高位 | 32位角度高16位 | 角度×100存儲 |
| 844 | 檢測角度低位 | 32位角度低16位 | 角度×100存儲 |
| 845 | 長軸長度 | 像素單位 | 橢圓模式時有效 |
| 846 | 短軸長度 | 像素單位 | 橢圓模式時有效 |
| 847 | 矩形寬度 | 像素單位 | 外接矩形模式時有效 |
| 848 | 矩形高度 | 像素單位 | 外接矩形模式時有效 |
| 849 | 檢測輪廓面積 | 像素平方 | 物體面積資訊 |
| 850 | 內徑高位 | 32位內徑高16位 | 預留擴展使用 |
| 851 | 內徑低位 | 32位內徑低16位 | 預留擴展使用 |
| 852 | 外徑高位 | 32位外徑高16位 | 預留擴展使用 |
| 853 | 外徑低位 | 32位外徑低16位 | 預留擴展使用 |
| 854-859 | 保留結果 | - | 未來擴展使用 |

### 統計資訊 (880-899)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 880 | 最後拍照耗時 | 毫秒單位 | 圖像捕獲時間 |
| 881 | 最後處理耗時 | 毫秒單位 | 角度檢測處理時間 |
| 882 | 最後總耗時 | 毫秒單位 | 完整操作時間 |
| 883 | 操作計數器 | 累積次數 | 成功操作統計 |
| 884 | 錯誤計數器 | 累積次數 | 失敗操作統計 |
| 885 | 連接計數器 | 累積次數 | 連接次數統計 |
| 890 | 軟體版本主號 | 版本號 | 主版本號 |
| 891 | 軟體版本次號 | 版本號 | 次版本號 |
| 892 | 運行時間小時 | 小時數 | 系統運行時間 |
| 893 | 運行時間分鐘 | 分鐘數 | 系統運行時間 |
| 894-899 | 保留統計 | - | 未來擴展使用 |

### CCD3握手操作流程
1. 檢查801寄存器Ready=1
2. 設置檢測參數 (810-819)
3. 發送控制指令 (800寄存器)
4. 等待執行完成 (801寄存器Running=0)
5. 讀取檢測結果 (840-859)
6. 清除控制指令 (800=0)

### CCD3角度精度處理
```python
# 角度存儲到寄存器 (保留2位小數)
angle_int = int(angle * 100)
angle_high = (angle_int >> 16) & 0xFFFF
angle_low = angle_int & 0xFFFF

# 寄存器恢復角度
angle_int = (angle_high << 16) | angle_low
final_angle = angle_int / 100.0
```

### CCD3檢測模式說明
- **橢圓擬合模式 (mode=0)**: 適用於圓形或橢圓形物體角度檢測
- **最小外接矩形模式 (mode=1)**: 適用於矩形或不規則物體角度檢測

## CCD視覺檢測模組 (基地址200) - v4.0 世界座標版本

### 握手控制寄存器
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 200 | 控制指令 | 0=清空, 8=拍照, 16=拍照+檢測, 32=重新初始化 |
| 201 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized |

### 檢測參數設定 (210-219)
| 地址 | 功能 | 範圍 |
|------|------|------|
| 210-211 | 最小面積(32位) | 高位/低位 |
| 212 | 最小圓度 | 值×1000 |
| 213-215 | 處理參數 | 高斯核/Canny閾值 |

### 像素座標檢測結果 (240-255)
| 地址 | 功能 | 說明 |
|------|------|------|
| 240 | 檢測圓形數量 | 最多5個 |
| 241-243 | 圓形1像素座標半徑 | X, Y, Radius |
| 244-246 | 圓形2像素座標半徑 | X, Y, Radius |
| 247-249 | 圓形3像素座標半徑 | X, Y, Radius |
| 250-252 | 圓形4像素座標半徑 | X, Y, Radius |
| 253-255 | 圓形5像素座標半徑 | X, Y, Radius |

### 世界座標檢測結果 (256-276) - 新增
| 地址 | 功能 | 說明 |
|------|------|------|
| 256 | 世界座標有效標誌 | 0=無效, 1=有效 |
| 257-258 | 圓形1世界X座標 | 高位/低位 (×100精度) |
| 259-260 | 圓形1世界Y座標 | 高位/低位 (×100精度) |
| 261-262 | 圓形2世界X座標 | 高位/低位 (×100精度) |
| 263-264 | 圓形2世界Y座標 | 高位/低位 (×100精度) |
| 265-266 | 圓形3世界X座標 | 高位/低位 (×100精度) |
| 267-268 | 圓形3世界Y座標 | 高位/低位 (×100精度) |
| 269-270 | 圓形4世界X座標 | 高位/低位 (×100精度) |
| 271-272 | 圓形4世界Y座標 | 高位/低位 (×100精度) |
| 273-274 | 圓形5世界X座標 | 高位/低位 (×100精度) |
| 275-276 | 圓形5世界Y座標 | 高位/低位 (×100精度) |

### 統計資訊 (280-299)
| 地址 | 功能 | 說明 |
|------|------|------|
| 280 | 最後拍照耗時 | 毫秒單位 |
| 281 | 最後處理耗時 | 毫秒單位 |
| 282 | 最後總耗時 | 毫秒單位 |
| 283 | 操作計數器 | 累積操作次數 |
| 284 | 錯誤計數器 | 累積錯誤次數 |
| 285 | 連接計數器 | 累積連接次數 |
| 290 | 軟體版本主號 | 版本4 (新增世界座標功能) |
| 291 | 軟體版本次號 | 版本0 |
| 292 | 運行時間小時 | 系統運行時間 |
| 293 | 運行時間分鐘 | 系統運行時間 |

### 世界座標轉換說明
- **精度處理**: 世界座標乘以100儲存為整數，保留2位小數精度
- **數值範圍**: 32位有符號整數，支援 ±21474.83mm 範圍
- **轉換條件**: 需要有效的相機內外參數據 (NPY格式)
- **座標系統**: 假設物體位於Z=0平面

### 內外參檔案要求
- **內參檔案**: camera_matrix_YYYYMMDD_HHMMSS.npy + dist_coeffs_YYYYMMDD_HHMMSS.npy
- **外參檔案**: extrinsic_*.npy (包含rvec和tvec的字典格式)
- **檔案位置**: 程式同層目錄
- **格式驗證**: 自動檢查NPY檔案格式正確性

### 握手操作流程
1. 檢查201寄存器Ready=1
2. 寫入200寄存器控制指令
3. 等待201寄存器Running=0
4. 讀取像素座標檢測結果 (240-255)
5. 讀取世界座標檢測結果 (256-276) - 需檢查256標誌位
6. 寫入200=0清除指令

### 世界座標數值恢復
```python
# 從32位整數恢復世界座標 (mm)
world_x_int = (high_16bit << 16) | low_16bit
world_x_mm = world_x_int / 100.0  # 恢復小數點

# 範例: 寄存器值 [1, 23400] → 世界座標 65770.00mm
```

## VP震動盤模組 (基地址300)

### 狀態寄存器 (300-314)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 300 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 4=錯誤 |
| 301 | 設備連接狀態 | 0=斷開, 1=已連接 |
| 310-312 | 背光/震動狀態 | 亮度/開關/震動 |

### 指令寄存器 (320-324)
| 地址 | 功能 | 說明 |
|------|------|------|
| 320 | 指令代碼 | 見下方指令表 |
| 321 | 參數1 | 動作碼/亮度值 |
| 322 | 參數2 | 強度/頻率 |
| 323 | 指令ID | 防重複執行 |

### VP指令映射
| 代碼 | 功能 | 參數1 | 參數2 |
|------|------|-------|-------|
| 1 | 背光開啟 | - | - |
| 2 | 背光關閉 | - | - |
| 4 | 設定背光亮度 | 0-255 | - |
| 5 | 執行震動動作 | 動作碼0-11 | 強度 |
| 6 | 緊急停止 | - | - |

### 震動動作碼
| 代碼 | 動作 | 代碼 | 動作 |
|------|------|------|------|
| 0 | stop | 6 | downleft |
| 1 | up | 7 | upright |
| 2 | down | 8 | downright |
| 3 | left | 9 | horizontal |
| 4 | right | 10 | vertical |
| 5 | upleft | 11 | spread |

## Gripper夾爪模組 (基地址500)

### 三款夾爪地址分配
| 夾爪型號 | unit_id | 狀態寄存器 | 指令寄存器 |
|----------|---------|------------|------------|
| PGC | 6 | 500-519 | 520-529 |
| PGHL | 5 | 530-549 | 550-559 |
| PGE | 4 | 560-579 | 580-589 |

### 統一指令映射 (各夾爪+0偏移)
| 代碼 | 功能 | 參數1 | 說明 |
|------|------|-------|------|
| 1 | 初始化 | - | 回零動作 |
| 2 | 停止 | - | 停止當前動作 |
| 3 | 絕對位置 | 位置值 | 移動到指定位置 |
| 5 | 設定力道 | 20-100 | 夾持力道 |
| 7 | 快速開啟 | - | 移動到開啟位置 |
| 8 | 快速關閉 | - | 移動到關閉位置 |

### 夾爪操作範例
```
# PGC夾爪初始化
寫入520=1, 523=指令ID

# PGHL夾爪移動到位置1000
寫入550=3, 551=1000, 553=指令ID

# PGE夾爪快速關閉
寫入580=8, 583=指令ID
```

## LED控制器模組 (基地址600)

### 狀態寄存器 (600-615)
| 地址 | 功能 | 範圍 |
|------|------|------|
| 600 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 4=錯誤 |
| 604-607 | L1-L4狀態 | 0=OFF, 1=ON |
| 608-611 | L1-L4亮度 | 0-511 |

### 指令寄存器 (620-624)
| 地址 | 功能 | 說明 |
|------|------|------|
| 620 | 指令代碼 | 見下方指令表 |
| 621 | 參數1 | 通道號1-4/亮度值 |
| 622 | 參數2 | 亮度值0-511 |
| 623 | 指令ID | 防重複執行 |

### LED指令映射
| 代碼 | 功能 | 參數1 | 參數2 |
|------|------|-------|-------|
| 1 | 全部開啟 | - | - |
| 2 | 全部關閉 | - | - |
| 4 | 設定通道亮度 | 通道1-4 | 亮度0-511 |
| 5 | 開啟通道 | 通道1-4 | - |
| 6 | 關閉通道 | 通道1-4 | - |

## XC100升降模組 (基地址1000)

### 狀態寄存器 (1000-1014)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 1000 | 模組狀態 | 0=離線, 1=閒置, 2=移動中, 3=原點復歸中 |
| 1001 | XC設備連接 | 0=斷開, 1=已連接 |
| 1002 | Servo狀態 | 0=OFF, 1=ON |
| 1004-1005 | 當前位置(32位) | 低位/高位 |
| 1006-1007 | 目標位置(32位) | 低位/高位 |

### 指令寄存器 (1020-1024)
| 地址 | 功能 | 說明 |
|------|------|------|
| 1020 | 指令代碼 | 見下方指令表 |
| 1021-1022 | 位置參數(32位) | 低位/高位 |
| 1023 | 指令ID | 防重複執行 |

### XC100指令映射
| 代碼 | 功能 | 參數說明 |
|------|------|----------|
| 1 | SERVO_ON | 啟動伺服馬達 |
| 2 | SERVO_OFF | 停止伺服馬達 |
| 3 | HOME | 原點復歸 |
| 4 | MOVE_ABS | 絕對位置移動(32位) |
| 5 | MOVE_REL | 相對位置移動(32位) |
| 6 | EMERGENCY_STOP | 緊急停止 |

## 通用操作規範

### 指令執行標準流程
1. 讀取模組狀態確認Ready
2. 寫入指令代碼和參數
3. 寫入唯一指令ID
4. 等待執行狀態清除
5. 讀取執行結果

### 指令ID機制
- 每次操作使用遞增的唯一ID
- 防止重複執行相同指令
- 指令完成後寄存器自動清零

### 錯誤處理
- 檢查模組狀態判斷連接
- 監控錯誤計數寄存器
- 異常時使用錯誤重置指令(代碼7)

### 32位數值處理
```
# 發送32位數值
高位 = (數值 >> 16) & 0xFFFF
低位 = 數值 & 0xFFFF

# 接收32位數值  
數值 = (高位 << 16) | 低位
```

### CCD世界座標專用處理
```
# 世界座標轉換為寄存器值 (保留2位小數)
world_coord_int = int(world_coord_mm * 100)
高位 = (world_coord_int >> 16) & 0xFFFF
低位 = world_coord_int & 0xFFFF

# 寄存器值恢復為世界座標
world_coord_int = (高位 << 16) | 低位
world_coord_mm = world_coord_int / 100.0
```

### CCD3角度專用處理
```
# 角度轉換為寄存器值 (保留2位小數)
angle_int = int(angle_degrees * 100)
高位 = (angle_int >> 16) & 0xFFFF
低位 = angle_int & 0xFFFF

# 寄存器值恢復為角度
angle_int = (高位 << 16) | 低位
angle_degrees = angle_int / 100.0
```

## Web介面端口
| 模組 | Web端口 | 訪問地址 |
|------|---------|----------|
| CCD視覺 | 5051 | localhost:5051 |
| **CCD3角度辨識** | **5052** | **localhost:5052** |
| VP震動盤 | 5053 | localhost:5053 |
| Gripper夾爪 | 5054 | localhost:5054 |
| XC100升降 | 5007 | localhost:5007 |
| LED控制器 | 5008 | localhost:5008 |

## 系統啟動順序
1. 啟動主Modbus TCP Server (端口502)
2. 啟動各模組主程序
3. 啟動各模組Web應用
4. 透過Web介面或直接寄存器操作控制設備

## CCD視覺模組世界座標功能使用流程
1. 將內外參NPY檔案放入CCD程式同層目錄
2. 啟動CCD視覺系統 (localhost:5051)
3. 點擊「掃描檔案」確認NPY檔案
4. 點擊「確認導入」載入標定數據
5. 確認世界座標指示器顯示「已啟用」
6. 執行「拍照+檢測」指令
7. 讀取像素座標 (240-255) 和世界座標 (256-276)
8. 檢查256寄存器確認世界座標有效性

## CCD3角度辨識模組使用流程
1. 啟動CCD3角度辨識系統 (localhost:5052)
2. 連接Modbus服務器 (127.0.0.1:502)
3. 初始化相機 (192.168.1.10)
4. 設置檢測參數 (810-819寄存器)
5. 執行「拍照+角度檢測」指令
6. 讀取角度檢測結果 (840-859寄存器)
7. 監控統計資訊 (880-899寄存器)

## 更新記錄

### v5.0 (2024-12-XX) - CCD3角度辨識模組
- **新增模組**: CCD3角度辨識模組 (基地址800-899)
- **新增功能**: Ring物件角度檢測，支援橢圓擬合和矩形模式
- **新增寄存器**: 角度檢測參數、結果、統計資訊完整映射
- **新增API**: 角度檢測算法封裝和Web介面控制
- **預留擴展**: 內外徑檢測寄存器 (850-853) 待整合
- **端口分配**: Web端口5052專用於CCD3模組
- **精度支援**: 角度保留2位小數精度 (×100整數存儲)

### v4.0 (2024-12-XX) - CCD視覺模組世界座標功能
- **新增寄存器**: 256-276 世界座標檢測結果區域
- **新增功能**: 內外參NPY檔案管理
- **新增功能**: 像素座標到世界座標轉換 (Z=0平面)
- **擴展API**: 標定檔案掃描、載入、狀態查詢
- **UI改進**: 世界座標狀態顯示、檔案管理介面
- **精度支援**: 世界座標保留2位小數精度 (×100整數存儲)
- **版本升級**: 軟體版本號升級到4.0