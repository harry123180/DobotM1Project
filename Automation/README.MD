# Modbus狀態機交握地址總表

## 系統架構
主服務器 (ModbusTCP:502) 統一管理所有模組，各模組基地址不重疊。

## 模組基地址分配
| 模組 | 基地址 | 狀態區 | 指令區 | 通訊協議 | 端口 |
|------|--------|--------|--------|----------|------|
| CCD視覺檢測 | 200 | 200-219 | 200-201(握手) | TCP Client + 相機直連 | - |
| VP震動盤 | 300 | 300-314 | 320-324 | TCP → TCP橋接 | 192.168.1.7:1000 |
| 機械臂(規劃) | 400 | 400-449 | - | 待實現 | - |
| Gripper夾爪 | 500 | 500-589 | - | RTU轉TCP橋接 | COM5(三款夾爪) |
| LED控制器 | 600 | 600-615 | 620-624 | RS232轉TCP橋接 | COM6 |
| XC100升降 | 1000 | 1000-1014 | 1020-1024 | RTU轉TCP橋接 | COM5 |

## CCD視覺檢測模組 (基地址200)

### 握手控制寄存器
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 200 | 控制指令 | 0=清空, 8=拍照, 16=拍照+檢測, 32=重新初始化 |
| 201 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized |

### 檢測參數設定 (210-219)
| 地址 | 功能 | 範圍 |
|------|------|------|
| 210-211 | 最小面積(32位) | 高位/低位 |
| 212 | 最小圓度 | 值×1000 |
| 213-215 | 處理參數 | 高斯核/Canny閾值 |

### 檢測結果輸出 (240-279)
| 地址 | 功能 | 說明 |
|------|------|------|
| 240 | 檢測圓形數量 | 最多5個 |
| 241-255 | 圓形1-5座標半徑 | X,Y,R格式 |

### 握手操作流程
1. 檢查201寄存器Ready=1
2. 寫入200寄存器控制指令
3. 等待201寄存器Running=0
4. 讀取檢測結果
5. 寫入200=0清除指令

## VP震動盤模組 (基地址300)

### 狀態寄存器 (300-314)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 300 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 4=錯誤 |
| 301 | 設備連接狀態 | 0=斷開, 1=已連接 |
| 310-312 | 背光/震動狀態 | 亮度/開關/震動 |

### 指令寄存器 (320-324)
| 地址 | 功能 | 說明 |
|------|------|------|
| 320 | 指令代碼 | 見下方指令表 |
| 321 | 參數1 | 動作碼/亮度值 |
| 322 | 參數2 | 強度/頻率 |
| 323 | 指令ID | 防重複執行 |

### VP指令映射
| 代碼 | 功能 | 參數1 | 參數2 |
|------|------|-------|-------|
| 1 | 背光開啟 | - | - |
| 2 | 背光關閉 | - | - |
| 4 | 設定背光亮度 | 0-255 | - |
| 5 | 執行震動動作 | 動作碼0-11 | 強度 |
| 6 | 緊急停止 | - | - |

### 震動動作碼
| 代碼 | 動作 | 代碼 | 動作 |
|------|------|------|------|
| 0 | stop | 6 | downleft |
| 1 | up | 7 | upright |
| 2 | down | 8 | downright |
| 3 | left | 9 | horizontal |
| 4 | right | 10 | vertical |
| 5 | upleft | 11 | spread |

## Gripper夾爪模組 (基地址500)

### 三款夾爪地址分配
| 夾爪型號 | unit_id | 狀態寄存器 | 指令寄存器 |
|----------|---------|------------|------------|
| PGC | 6 | 500-519 | 520-529 |
| PGHL | 5 | 530-549 | 550-559 |
| PGE | 4 | 560-579 | 580-589 |

### 統一指令映射 (各夾爪+0偏移)
| 代碼 | 功能 | 參數1 | 說明 |
|------|------|-------|------|
| 1 | 初始化 | - | 回零動作 |
| 2 | 停止 | - | 停止當前動作 |
| 3 | 絕對位置 | 位置值 | 移動到指定位置 |
| 5 | 設定力道 | 20-100 | 夾持力道 |
| 7 | 快速開啟 | - | 移動到開啟位置 |
| 8 | 快速關閉 | - | 移動到關閉位置 |

### 夾爪操作範例
```
# PGC夾爪初始化
寫入520=1, 523=指令ID

# PGHL夾爪移動到位置1000
寫入550=3, 551=1000, 553=指令ID

# PGE夾爪快速關閉
寫入580=8, 583=指令ID
```

## LED控制器模組 (基地址600)

### 狀態寄存器 (600-615)
| 地址 | 功能 | 範圍 |
|------|------|------|
| 600 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 4=錯誤 |
| 604-607 | L1-L4狀態 | 0=OFF, 1=ON |
| 608-611 | L1-L4亮度 | 0-511 |

### 指令寄存器 (620-624)
| 地址 | 功能 | 說明 |
|------|------|------|
| 620 | 指令代碼 | 見下方指令表 |
| 621 | 參數1 | 通道號1-4/亮度值 |
| 622 | 參數2 | 亮度值0-511 |
| 623 | 指令ID | 防重複執行 |

### LED指令映射
| 代碼 | 功能 | 參數1 | 參數2 |
|------|------|-------|-------|
| 1 | 全部開啟 | - | - |
| 2 | 全部關閉 | - | - |
| 4 | 設定通道亮度 | 通道1-4 | 亮度0-511 |
| 5 | 開啟通道 | 通道1-4 | - |
| 6 | 關閉通道 | 通道1-4 | - |

## XC100升降模組 (基地址1000)

### 狀態寄存器 (1000-1014)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 1000 | 模組狀態 | 0=離線, 1=閒置, 2=移動中, 3=原點復歸中 |
| 1001 | XC設備連接 | 0=斷開, 1=已連接 |
| 1002 | Servo狀態 | 0=OFF, 1=ON |
| 1004-1005 | 當前位置(32位) | 低位/高位 |
| 1006-1007 | 目標位置(32位) | 低位/高位 |

### 指令寄存器 (1020-1024)
| 地址 | 功能 | 說明 |
|------|------|------|
| 1020 | 指令代碼 | 見下方指令表 |
| 1021-1022 | 位置參數(32位) | 低位/高位 |
| 1023 | 指令ID | 防重複執行 |

### XC100指令映射
| 代碼 | 功能 | 參數說明 |
|------|------|----------|
| 1 | SERVO_ON | 啟動伺服馬達 |
| 2 | SERVO_OFF | 停止伺服馬達 |
| 3 | HOME | 原點復歸 |
| 4 | MOVE_ABS | 絕對位置移動(32位) |
| 5 | MOVE_REL | 相對位置移動(32位) |
| 6 | EMERGENCY_STOP | 緊急停止 |

## 通用操作規範

### 指令執行標準流程
1. 讀取模組狀態確認Ready
2. 寫入指令代碼和參數
3. 寫入唯一指令ID
4. 等待執行狀態清除
5. 讀取執行結果

### 指令ID機制
- 每次操作使用遞增的唯一ID
- 防止重複執行相同指令
- 指令完成後寄存器自動清零

### 錯誤處理
- 檢查模組狀態判斷連接
- 監控錯誤計數寄存器
- 異常時使用錯誤重置指令(代碼7)

### 32位數值處理
```
# 發送32位數值
高位 = (數值 >> 16) & 0xFFFF
低位 = 數值 & 0xFFFF

# 接收32位數值  
數值 = (高位 << 16) | 低位
```

## Web介面端口
| 模組 | Web端口 | 訪問地址 |
|------|---------|----------|
| CCD視覺 | 5051 | localhost:5051 |
| VP震動盤 | 5053 | localhost:5053 |
| Gripper夾爪 | 5054 | localhost:5054 |
| XC100升降 | 5007 | localhost:5007 |
| LED控制器 | 5008 | localhost:5008 |

## 系統啟動順序
1. 啟動主Modbus TCP Server (端口502)
2. 啟動各模組主程序
3. 啟動各模組Web應用
4. 透過Web介面或直接寄存器操作控制設備