# Modbus RTU轉TCP架構技術規範

## 系統架構

```
主服務器 (ModbusTCPServer:502)
    |
    |-- TCP --> 客戶端模組1 (升降運動模組)
    |-- TCP --> 客戶端模組2 (視覺檢測模組) 
    |-- TCP --> 客戶端模組3 (機械臂控制模組)
    |-- TCP --> 客戶端模組N
    
每個客戶端: TCP Client <--> RTU Serial <--> 實體設備
```

## 核心組件

### 主服務器 (ModbusTCPServer)
- 端口: 502
- 功能: 提供Modbus TCP服務，管理寄存器映射

### 客戶端模組 (Client Modules)  
- 角色: Modbus TCP Client
- 功能: RTU轉TCP橋接
- 特性: 獨立程序，狀態機交握，自動重連

## 寄存器映射規範

### 基地址配置
- 升降運動模組基地址: 1000 (佔用1000-1049)
- 視覺檢測模組基地址: 200 (佔用200-299)
- 每個模組佔用: 50個寄存器
- 可通過配置檔案調整基地址

## 升降運動模組寄存器映射

### 狀態寄存器區 (只讀)
升降模組基地址 + 0 ~ 14

| 實際地址 | 偏移 | 功能 | 數值定義 |
|---------|------|------|----------|
| 1000 | +0 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 3=初始化, 4=錯誤, 5=停用, 6=緊急停止 |
| 1001 | +1 | 設備連接狀態 | 0=斷開, 1=已連接 |
| 1002 | +2 | 設備狀態 | 升降模組Servo狀態 (0=OFF, 1=ON) |
| 1003 | +3 | 錯誤代碼 | 錯誤編號，0=無錯誤 |
| 1004 | +4 | 當前位置低位 | 升降模組當前位置低16位 |
| 1005 | +5 | 當前位置高位 | 升降模組當前位置高16位 |
| 1006 | +6 | 目標位置低位 | 升降模組目標位置低16位 |
| 1007 | +7 | 目標位置高位 | 升降模組目標位置高16位 |
| 1008 | +8 | 指令執行狀態 | 0=空閒, 1=執行中 |
| 1009 | +9 | 通訊錯誤計數 | 累積錯誤次數 |
| 1010 | +10 | 位置A低位 | 升降模組預設位置A低16位 |
| 1011 | +11 | 位置A高位 | 升降模組預設位置A高16位 |
| 1012 | +12 | 位置B低位 | 升降模組預設位置B低16位 |
| 1013 | +13 | 位置B高位 | 升降模組預設位置B高16位 |
| 1014 | +14 | 時間戳 | 最後更新時間戳 |

### 指令寄存器區 (讀寫)
升降模組基地址 + 20 ~ 24

| 實際地址 | 偏移 | 功能 | 說明 |
|---------|------|------|------|
| 1020 | +20 | 指令代碼 | 執行的指令類型 |
| 1021 | +21 | 參數1 | 第一個參數 (如位置低位) |
| 1022 | +22 | 參數2 | 第二個參數 (如位置高位) |
| 1023 | +23 | 指令ID | 唯一識別碼，防重複執行 |
| 1024 | +24 | 預留 | 保留欄位 |

## 視覺檢測模組寄存器映射

### 控制握手寄存器區
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 200 | 控制指令 | 0=清空, 8=拍照, 16=拍照+檢測, 32=重新初始化 |
| 201 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized |

### 檢測參數寄存器區 (210-219)
| 地址 | 功能 | 說明 |
|------|------|------|
| 210 | 最小面積高位 | 32位面積值的高16位 |
| 211 | 最小面積低位 | 32位面積值的低16位 |
| 212 | 最小圓度 | 圓度值乘以1000 |
| 213 | 高斯核大小 | 圖像處理核心大小 |
| 214 | Canny低閾值 | 邊緣檢測低閾值 |
| 215 | Canny高閾值 | 邊緣檢測高閾值 |

### 檢測結果寄存器區 (240-279)
| 地址範圍 | 功能 | 說明 |
|----------|------|------|
| 240 | 圓形數量 | 檢測到的圓形總數 |
| 241-243 | 圓形1資料 | X座標, Y座標, 半徑 |
| 244-246 | 圓形2資料 | X座標, Y座標, 半徑 |
| 247-249 | 圓形3資料 | X座標, Y座標, 半徑 |
| 250-252 | 圓形4資料 | X座標, Y座標, 半徑 |
| 253-255 | 圓形5資料 | X座標, Y座標, 半徑 |

### 統計資訊寄存器區 (280-299)
| 地址 | 功能 | 單位 |
|------|------|------|
| 280 | 最後拍照時間 | 毫秒 |
| 281 | 最後處理時間 | 毫秒 |
| 282 | 最後總時間 | 毫秒 |
| 283 | 操作計數器 | 累計次數 |
| 284 | 錯誤計數器 | 累計錯誤 |
| 285 | 連接計數器 | 累計連接 |
| 290 | 版本主號 | 軟體版本 |
| 291 | 版本次號 | 軟體版本 |
| 292 | 運行時間小時 | 小時 |
| 293 | 運行時間分鐘 | 分鐘 |

## 標準指令代碼

### 基本控制指令
| 代碼 | 指令名稱 | 參數1 | 參數2 | 說明 |
|------|---------|-------|-------|------|
| 0 | NOP | - | - | 無操作 |
| 1 | 設備啟用 | - | - | 升降模組Servo ON |
| 2 | 設備停用 | - | - | 升降模組Servo OFF |
| 3 | 初始化/歸原點 | - | - | 升降模組回到原點位置 |
| 4 | 絕對移動 | 位置低位 | 位置高位 | 升降模組移動到絕對位置 |
| 5 | 相對移動 | 距離低位 | 距離高位 | 升降模組相對移動 |
| 6 | 緊急停止 | - | - | 立即停止 |
| 7 | 錯誤重置 | - | - | 清除錯誤狀態 |

### 視覺檢測專用指令
| 代碼 | 指令名稱 | 參數1 | 參數2 | 說明 |
|------|---------|-------|-------|------|
| 8 | 拍照 | - | - | 單純拍照 |
| 16 | 拍照+檢測 | - | - | 拍照並執行圓形檢測 |
| 32 | 重新初始化 | - | - | 重新初始化相機和系統 |

### 設備專用指令
| 代碼範圍 | 用途 |
|----------|------|
| 11-30 | 升降運動模組專用 |
| 31-50 | 視覺檢測模組專用 |  
| 51-70 | 機械臂模組專用 |
| 71-90 | 感測器模組專用 |
| 91-99 | 用戶自定義 |

## 狀態機交握流程

### 升降運動模組指令執行流程
1. 外部系統寫入指令寄存器 (1020-1024)
2. 模組檢測新指令ID (1023)
3. 模組設置執行狀態 (1008=1)
4. 執行RTU通訊
5. 更新狀態寄存器 (1000-1014)
6. 清除執行狀態 (1008=0)
7. 清除指令寄存器 (1020-1024=0)

### 視覺檢測模組握手流程
1. 系統初始化完成，狀態寄存器(201) = 1 (Ready=1)
2. 外部系統檢測Ready=1，寫入控制指令(200)
3. 系統檢測到新指令，設置Running=1, Ready=0
4. 執行相應動作 (拍照/檢測/初始化)
5. 動作完成，設置Running=0
6. 外部系統寫入控制指令(200)=0清空
7. 系統檢測指令清空且Running=0，恢復Ready=1

### 狀態位定義 (視覺檢測模組)
| 位置 | 名稱 | 說明 |
|------|------|------|
| bit0 | Ready | 系統準備接受新指令 |
| bit1 | Running | 系統正在執行操作 |
| bit2 | Alarm | 系統異常或錯誤 |
| bit3 | Initialized | 系統已完全初始化 |

### 32位數值處理
```python
# 合併32位數值
value_32bit = (high_16bit << 16) | low_16bit

# 分離32位數值  
low_16bit = value_32bit & 0xFFFF
high_16bit = (value_32bit >> 16) & 0xFFFF
```

## 模組開發規範

### 升降運動模組配置範例
```json
{
  "module_id": "升降運動模組",
  "device_connection": {
    "port": "COM5",
    "baudrate": 115200,
    "unit_id": 2,
    "timeout": 0.2
  },
  "tcp_server": {
    "host": "127.0.0.1", 
    "port": 502,
    "unit_id": 1,
    "timeout": 1.0
  },
  "modbus_mapping": {
    "base_address": 1000
  },
  "timing": {
    "fast_loop_interval": 0.02,
    "movement_delay": 0.1,
    "command_delay": 0.02
  }
}
```

### 視覺檢測模組配置範例
```json
{
  "module_id": "視覺檢測模組",
  "device_connection": {
    "camera_ip": "192.168.1.8",
    "camera_name": "cam_1",
    "timeout": 3.0
  },
  "tcp_server": {
    "host": "127.0.0.1",
    "port": 502,
    "unit_id": 1,
    "timeout": 1.0
  },
  "modbus_mapping": {
    "base_address": 200
  },
  "timing": {
    "handshake_interval": 0.05,
    "status_update_interval": 0.02
  }
}
```

### 必需實現方法
```python
# 升降運動模組
def connect_main_server() -> bool
def connect_device() -> bool  
def execute_command(command, param1, param2) -> bool
def update_status_registers()
def start() -> bool
def stop()

# 視覺檢測模組額外方法
def capture_image() -> Tuple[Optional[np.ndarray], float]
def capture_and_detect() -> VisionResult
def update_detection_results(result: VisionResult)
def _update_status_to_plc()
def _process_handshake_control()
```

### 線程安全要求
- 使用鎖保護共享狀態變量
- 狀態更新必須原子化操作
- 實現錯誤計數和重連機制

## 通訊時序

### 循環頻率
- 升降運動模組主循環: 20ms (可調整至10-50ms)
- 視覺檢測模組握手循環: 50ms (高頻輪詢)
- 狀態更新: 每個循環
- 指令檢測: 每個循環
- 錯誤重試: 最大3次

### 超時設定
- RTU通訊: 200ms
- TCP連接: 1000ms
- 視覺檢測TCP連接: 3000ms
- 指令執行: 根據設備特性設定

## 錯誤處理機制

### 錯誤代碼定義
| 代碼 | 說明 |
|------|------|
| 0 | 無錯誤 |
| 1 | 通訊超時 |
| 2 | 設備未連接 |
| 3 | 參數錯誤 |
| 4 | 位置超限 |
| 5 | 設備故障 |
| 6 | 圖像捕獲失敗 |
| 7 | 檢測演算法失敗 |
| 8 | 相機初始化失敗 |
| 99 | 未知錯誤 |

### 重連機制
- TCP斷線: 自動重連，最大重試3次
- RTU斷線: 嘗試重連，記錄錯誤計數
- 相機斷線: 設置Alarm狀態，需手動重新初始化
- 超過最大錯誤次數: 設置錯誤狀態

## Flask Web應用規範

### 每個模組必須包含App.py
- 基於Flask的Web可視化介面
- 獨立的Modbus TCP Client
- 針對各自模組的Address可視化監控
- 提供參數設定和狀態監控功能
- 支援即時數據更新和Socket.IO通訊

### Web介面必需功能
- 模組狀態監控
- 寄存器數值顯示
- 參數設定介面
- 錯誤日誌顯示
- 連接管理控制