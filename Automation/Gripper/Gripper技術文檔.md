# Gripper夾爪模組技術文檔

## 架構概述

Gripper夾爪模組實現RTU轉TCP橋接，支援三種夾爪型號同時運行。

```
主服務器 (ModbusTCP:502)
    |
    |-- TCP --> Gripper.py (TCP Client)
                    |
                    |-- RTU --> PGC夾爪 (COM5, unit_id=6)
                    |-- RTU --> PGHL夾爪 (COM5, unit_id=5)
                    |-- RTU --> PGE夾爪 (COM5, unit_id=4)
    |
    |-- TCP --> Gripper_app.py (獨立TCP Client)
```

## 實現組件

### Gripper.py - 主模組
- TCP Client連接主服務器 (127.0.0.1:502)
- RTU Serial連接三款夾爪 (COM5, 115200)
- 寄存器映射基地址: 500-589
- 狀態監控循環: 50ms間隔

### Gripper_app.py - Web控制應用
- 獨立TCP Client連接主服務器 (127.0.0.1:502)
- Flask Web介面 (0.0.0.0:5054)
- SocketIO即時通訊支援
- 三款夾爪獨立控制區域

## 寄存器映射 (基地址500-589)

### 地址分配
| 夾爪型號 | unit_id | 狀態寄存器 | 指令寄存器 |
|----------|---------|------------|------------|
| PGC | 6 | 500-519 | 520-529 |
| PGHL | 5 | 530-549 | 550-559 |
| PGE | 4 | 560-579 | 580-589 |

### 狀態寄存器映射 (各夾爪20個寄存器)
| 偏移 | 功能 | 數值定義 |
|------|------|----------|
| +0 | 模組狀態 | 0=離線, 1=在線 |
| +1 | 連接狀態 | 0=斷開, 1=已連接 |
| +2 | 設備狀態 | 初始化狀態或回零狀態 |
| +3 | 錯誤計數 | 累積錯誤次數 |
| +4 | 夾持狀態 | 運動狀態或夾持狀態 |
| +5 | 當前位置 | 位置值 |
| +6 | 電流值 | 僅PGHL有效 |
| +14 | 時間戳 | 最後更新時間戳 |

### 指令寄存器映射 (各夾爪10個寄存器)
| 偏移 | 功能 | 說明 |
|------|------|------|
| +0 | 指令代碼 | 執行的指令類型 |
| +1 | 參數1 | 位置、力道、速度等 |
| +2 | 參數2 | 保留參數 |
| +3 | 指令ID | 唯一識別碼，防重複執行 |
| +4-9 | 保留 | 保留欄位 |

## 統一指令映射

| 代碼 | 指令 | 參數1 | 參數2 | 功能 |
|------|------|-------|-------|------|
| 0 | NOP | - | - | 無操作 |
| 1 | 初始化 | - | - | 初始化/回零 |
| 2 | 停止 | - | - | 停止當前動作 |
| 3 | 絕對位置 | 位置值 | - | 移動到絕對位置 |
| 4 | 相對位置 | 距離值 | - | 相對移動 (僅PGHL) |
| 5 | 設定力道 | 力道值 | - | 設定夾持力道 |
| 6 | 設定速度 | 速度值 | - | 設定移動速度 |
| 7 | 快速開啟 | - | - | 移動到開啟位置 |
| 8 | 快速關閉 | - | - | 移動到關閉位置 |

## 三款夾爪RTU寄存器對應

### PGC夾爪 (unit_id=6)
| RTU寄存器 | 功能 | 數值範圍 | 對應指令 |
|----------|------|----------|----------|
| 0x0100 | 初始化控制 | 0x01=回零, 0=停止 | 1, 2 |
| 0x0101 | 力道設定 | 20-100 | 5 |
| 0x0103 | 位置設定 | 0-1000 | 3, 7, 8 |
| 0x0104 | 速度設定 | 1-100 | 6 |
| 0x0200 | 初始化狀態 | 0=未初始化, 1=成功, 2=進行中 | - |
| 0x0201 | 夾持狀態 | 0=運動中, 1=到達, 2=夾住, 3=掉落 | - |
| 0x0202 | 位置反饋 | 0-1000 | - |

### PGHL夾爪 (unit_id=5)
| RTU寄存器 | 功能 | 數值範圍 | 對應指令 |
|----------|------|----------|----------|
| 0x0100 | 回零控制 | 1=回零, 0=停止 | 1, 2 |
| 0x0101 | 推壓力設定 | 20-100 | 5 |
| 0x0103 | 目標位置 | 0-65535 (0.01mm) | 3, 7, 8 |
| 0x0104 | 最大速度 | 50-100 | 6 |
| 0x0106 | 相對位置 | -32767~32767 | 4 |
| 0x0200 | 回零狀態 | 0=未初始化, 1=成功, 2=進行中 | - |
| 0x0201 | 運行狀態 | 0=運動中, 1=到達, 2=堵轉, 3=掉落 | - |
| 0x0202 | 位置反饋 | 0-65535 (0.01mm) | - |
| 0x0204 | 電流反饋 | 電流值 | - |

### PGE夾爪 (unit_id=4)
| RTU寄存器 | 功能 | 數值範圍 | 對應指令 |
|----------|------|----------|----------|
| 0x0100 | 初始化控制 | 0x01=回零, 0=停止 | 1, 2 |
| 0x0101 | 力道設定 | 20-100 | 5 |
| 0x0103 | 位置設定 | 0-1000 | 3, 7, 8 |
| 0x0104 | 速度設定 | 1-100 | 6 |
| 0x0200 | 初始化狀態 | 0=未初始化, 1=成功, 2=進行中 | - |
| 0x0201 | 夾持狀態 | 0=運動中, 1=到達, 2=夾住, 3=掉落 | - |
| 0x0202 | 位置反饋 | 0-1000 | - |

## 狀態機交握流程

### Gripper.py主循環 (50ms)
1. 檢查TCP和RTU連接狀態
2. 每10個循環測試各夾爪連接狀態
3. 讀取指令寄存器檢查新指令ID
4. 執行夾爪RTU指令
5. 讀取夾爪狀態並更新狀態寄存器
6. 清除已執行的指令寄存器

### 指令執行流程
1. 讀取指令寄存器 (command_base+0~3)
2. 檢測新指令ID避免重複執行
3. 根據夾爪類型調用對應執行函數
4. 寫入RTU寄存器執行實際動作
5. 更新錯誤計數
6. 清除指令寄存器

## 配置檔案

### gripper_config.json (Gripper.py)
```json
{
  "rtu_connection": {
    "port": "COM5",
    "baudrate": 115200,
    "timeout": 1.0
  },
  "tcp_server": {
    "host": "127.0.0.1",
    "port": 502,
    "unit_id": 1
  },
  "timing": {
    "fast_loop_interval": 0.05
  },
  "grippers": {
    "PGC": {"unit_id": 6, "enabled": true},
    "PGHL": {"unit_id": 5, "enabled": true},
    "PGE": {"unit_id": 4, "enabled": true}
  }
}
```

### gripper_app_config.json (Gripper_app.py)
```json
{
  "web_server": {
    "host": "0.0.0.0",
    "port": 5054
  },
  "ui_settings": {
    "refresh_interval": 3.0,
    "manual_mode": false
  }
}
```

## Web API接口

### RESTful API
- POST `/api/connect`: 連接Modbus服務器
- GET `/api/status/<gripper_type>`: 獲取夾爪狀態
- POST `/api/initialize/<gripper_type>`: 初始化夾爪
- POST `/api/move/<gripper_type>`: 移動到指定位置
- POST `/api/set_force/<gripper_type>`: 設定力道
- POST `/api/open/<gripper_type>`: 開啟夾爪
- POST `/api/close/<gripper_type>`: 關閉夾爪

### SocketIO事件
- `start_monitoring`: 啟動狀態監控
- `status_update`: 狀態更新推送
- `request_status`: 請求狀態更新

## 實現關鍵技術

### PyModbus 3.x兼容性
使用關鍵字參數調用API：
```python
# 正確語法
result = client.read_holding_registers(address=0x0200, count=1, slave=unit_id)
result = client.write_register(address=0x0100, value=1, slave=unit_id)
```

### 線程安全
- 使用threading.Lock保護狀態變量
- 50ms主循環獨立執行緒
- 指令ID防重複執行機制

### 連接管理
- RTU連接斷線自動重連
- TCP連接斷線重連機制
- 各夾爪獨立錯誤計數

## 開發問題與修正

### 1. PyModbus API參數錯誤 (已修正)
**錯誤**: 使用PyModbus 2.x語法
```python
# 錯誤語法
result = client.read_holding_registers(0x0200, 1, slave=unit_id)
```
**修正**: 使用PyModbus 3.x關鍵字參數
```python
# 正確語法
result = client.read_holding_registers(address=0x0200, count=1, slave=unit_id)
```

### 2. 狀態寄存器更新邏輯錯誤 (已修正)
**問題**: Web介面顯示夾爪離線但RTU通訊正常
**原因**: update_status_registers函數中狀態判斷邏輯錯誤
**修正**: 
- 修正狀態寄存器數值設定邏輯
- 增加除錯輸出確認寄存器寫入
- 統一connected狀態判斷條件

### 3. 除錯輸出過多 (已修正)
**問題**: 狀態讀取成功訊息刷屏影響除錯
**修正**: 移除不必要的成功訊息，保留錯誤訊息

### 4. 配置檔案路徑 (已實現)
**實現**: 使用`os.path.dirname(os.path.abspath(__file__))`確保配置檔案生成在執行檔同層目錄

### 5. 夾爪連接測試頻率 (已優化)
**優化**: 每10個主循環才執行一次連接測試，減少RTU通訊負載

## 部署與測試

### 運行順序
1. 啟動主Modbus TCP Server (端口502)
2. 啟動Gripper.py (RTU橋接主程序)
3. 啟動Gripper_app.py (Web介面)
4. 訪問localhost:5054進行控制

### 檔案結構
```
Gripper/
├── Gripper.py                 # RTU橋接主程序
├── Gripper_app.py            # Web控制應用
├── gripper_config.json       # 主程序配置 (自動生成)
├── gripper_app_config.json   # Web應用配置 (自動生成)
└── templates/
    └── index.html            # Web介面
```

### 測試驗證
1. **連接測試**: 確認各夾爪RTU通訊正常
2. **功能測試**: 驗證初始化、位置控制、力道設定
3. **Web介面測試**: 確認狀態同步與指令執行

## 已知限制

### 硬體限制
- 所有夾爪使用相同COM5端口，依靠unit_id區分
- PGHL相對移動功能僅該型號支援
- PGC和PGE精度限制在0-1000範圍
- PGHL精度為0.01mm，範圍0-65535

### 軟體限制
- 50ms監控頻率下RTU通訊負載需監控
- 三款夾爪同時操作時序列埠競爭
- Web介面自動刷新可能干擾輸入操作

### 故障排除
1. **COM5權限問題**: 確保串口可用且無其他程序占用
2. **夾爪無回應**: 檢查unit_id設定和電源連接
3. **TCP連接失敗**: 確認主服務器運行狀態
4. **PyModbus版本**: 確保使用3.x版本並採用關鍵字參數語法

## 性能監控

### 關鍵指標
- RTU通訊錯誤率: 監控error_count寄存器
- 主循環執行頻率: 目標50ms間隔
- TCP連接穩定性: 監控主服務器連接狀態
- Web介面回應時間: 3秒刷新間隔

### 優化建議
- 根據實際需求調整fast_loop_interval
- 監控串口通訊負載避免衝突
- 適當調整連接測試頻率