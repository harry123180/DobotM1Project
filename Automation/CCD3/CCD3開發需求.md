# CCD3角度辨識模組開發需求書

## 專案基本資訊

### 模組定位
- **模組名稱**: CCD3角度辨識模組
- **功能目標**: 對ring狀物件進行角度辨識
- **專案路徑**: `Automation/CCD3/`
- **基地址分配**: 800-899

### 硬體配置
- **相機IP**: 192.168.1.10
- **Web介面端口**: 5052
- **訪問地址**: localhost:5052
- **通訊協議**: TCP Client + 相機直連

## 系統架構設計

### 通訊架構
```
主服務器 (ModbusTCP:502)
    |
    |-- TCP --> CCD3AngleDetection.py (TCP Client)
                    |
                    |-- 直連 --> 相機設備 (192.168.1.10)
```

### 檔案結構
```
Automation/CCD3/
├── CCD3AngleDetection.py          # 主程序
├── angle_detector.py              # 角度檢測算法封裝
├── templates/
│   └── ccd3_angle_detection.html  # Web介面
└── CCD3技術文檔.md                 # 技術文檔
```

## 功能需求規格

### 核心功能
1. **拍照功能**: 透過海康威視相機捕獲圖像
2. **角度檢測**: 使用既有opencv算法進行ring物件角度辨識
3. **雙模式支援**: 
   - 模式0: 橢圓擬合模式
   - 模式1: 最小外接矩形模式
4. **握手控制**: 實現運動控制握手協議
5. **Web控制**: 提供參數調整和手動控制介面

### 檢測對象
- **物體類型**: ring狀物件
- **檢測內容**: 物體旋轉角度
- **算法來源**: 既有opencv_detect_module.py (不需修改核心算法)

### 精度要求
- **角度精度**: 保留2位小數
- **存儲方式**: 角度×100存儲為整數寄存器
- **角度範圍**: ±180度

## Modbus寄存器映射規格

### 基地址分配
- **基地址**: 800
- **寄存器範圍**: 800-899
- **總計寄存器**: 100個

### 寄存器詳細映射

#### 核心控制握手寄存器 (800-801)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 800 | 控制指令 | 0=清空, 8=拍照, 16=拍照+角度檢測, 32=重新初始化 |
| 801 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized |

#### 檢測參數設定 (810-819)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 810 | 檢測模式 | 0=橢圓擬合模式, 1=最小外接矩形模式 | 透過寄存器選擇檢測模式 |
| 811 | 最小面積比例 | 乘以1000存儲 | 0.05 → 50 |
| 812 | 序列模式 | 0=最大輪廓, 1=序列輪廓 | 輪廓選擇方式 |
| 813 | 高斯模糊核大小 | 奇數值 | 3, 5, 7, 9等 |
| 814 | 閾值處理模式 | 0=OTSU自動, 1=手動 | 二值化處理方式 |
| 815 | 手動閾值 | 0-255 | 手動模式使用 |
| 816-819 | 保留參數 | - | 未來擴展使用 |

#### 角度檢測結果 (840-859)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 840 | 檢測成功標誌 | 0=失敗, 1=成功 | 檢測結果有效性 |
| 841 | 物體中心X座標 | 像素座標 | 檢測物體中心位置 |
| 842 | 物體中心Y座標 | 像素座標 | 檢測物體中心位置 |
| 843 | 檢測角度整數部分 | ±180度 | 角度整數部分 |
| 844 | 檢測角度小數部分 | ×100存儲 | 0.25° → 25 |
| 845 | 長軸長度 | 像素單位 | 橢圓模式時有效 |
| 846 | 短軸長度 | 像素單位 | 橢圓模式時有效 |
| 847 | 矩形寬度 | 像素單位 | 外接矩形模式時有效 |
| 848 | 矩形高度 | 像素單位 | 外接矩形模式時有效 |
| 849 | 檢測輪廓面積 | 像素平方 | 物體面積資訊 |
| 850-859 | 保留結果 | - | 未來擴展使用 |

#### 統計資訊 (880-899)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 880 | 最後拍照耗時 | 毫秒單位 | 圖像捕獲時間 |
| 881 | 最後處理耗時 | 毫秒單位 | 角度檢測處理時間 |
| 882 | 最後總耗時 | 毫秒單位 | 完整操作時間 |
| 883 | 操作計數器 | 累積次數 | 成功操作統計 |
| 884 | 錯誤計數器 | 累積次數 | 失敗操作統計 |
| 885 | 連接計數器 | 累積次數 | 連接次數統計 |
| 890 | 軟體版本主號 | 版本號 | 主版本號 |
| 891 | 軟體版本次號 | 版本號 | 次版本號 |
| 892 | 運行時間小時 | 小時數 | 系統運行時間 |
| 893 | 運行時間分鐘 | 分鐘數 | 系統運行時間 |
| 894-899 | 保留統計 | - | 未來擴展使用 |

## 握手協議規格

### 狀態機定義
- **Ready (bit0)**: 系統準備接受新指令
- **Running (bit1)**: 系統正在執行操作
- **Alarm (bit2)**: 系統異常或錯誤
- **Initialized (bit3)**: 系統已完全初始化

### 控制指令映射
| 指令碼 | 功能 | 執行內容 |
|--------|------|----------|
| 0 | 清空控制 | 狀態機恢復Ready |
| 8 | 拍照 | 單純圖像捕獲 |
| 16 | 拍照+角度檢測 | 圖像捕獲與角度檢測 |
| 32 | 重新初始化 | 相機重新初始化 |

### 握手操作流程
1. **檢查Ready狀態**: 讀取801寄存器bit0=1
2. **設置檢測參數**: 寫入810-819參數寄存器
3. **發送控制指令**: 寫入800寄存器控制指令
4. **等待執行完成**: 監控801寄存器Running=0
5. **讀取檢測結果**: 讀取840-859結果寄存器
6. **清除控制指令**: 寫入800=0，系統恢復Ready=1

## 算法整合規格

### 核心算法來源
- **檔案**: opencv_detect_module.py
- **函數**: get_obj_angle(image, mode)
- **要求**: 不修改核心算法邏輯，僅進行封裝整合

### 算法封裝設計
```python
class AngleDetector:
    def detect_angle(self, image, mode=0):
        """
        角度檢測主函數
        參數:
            image: 輸入圖像
            mode: 0=橢圓擬合模式, 1=最小外接矩形模式
        返回:
            center: (x, y) 物體中心座標
            angle: 檢測角度值
            additional_info: 額外資訊(長軸、矩形尺寸等)
        """
```

### 檢測結果格式
```python
class AngleResult:
    success: bool              # 檢測成功標誌
    center: Tuple[int, int]    # 物體中心座標
    angle: float               # 檢測角度(-180~180度)
    major_axis: float          # 長軸長度(橢圓模式)
    minor_axis: float          # 短軸長度(橢圓模式)
    rect_width: float          # 矩形寬度(矩形模式)
    rect_height: float         # 矩形高度(矩形模式)
    contour_area: float        # 輪廓面積
    processing_time: float     # 處理耗時
```

## Web介面需求

### 介面功能
1. **連接管理**: Modbus TCP連接控制
2. **相機控制**: 相機初始化與連接
3. **參數設定**: 檢測模式和參數調整
4. **手動控制**: 拍照和角度檢測操作
5. **結果顯示**: 角度檢測結果和圖像顯示
6. **狀態監控**: 系統狀態和握手協議監控
7. **寄存器監控**: 即時寄存器數值顯示

### 介面設計風格
- **設計風格**: 簡約、清晰、白藍漸層
- **響應式設計**: 支援不同螢幕尺寸
- **即時更新**: SocketIO即時通訊
- **狀態指示**: 視覺化狀態指示器

## 技術規格

### 依賴模組
- **PyModbus**: 3.9.2 (Modbus TCP Client)
- **OpenCV**: 圖像處理與角度檢測
- **NumPy**: 數值計算
- **Flask + SocketIO**: Web介面
- **海康威視SDK**: 相機控制

### 相機配置
```python
CameraConfig:
    name: "ccd3_camera"
    ip: "192.168.1.10"
    exposure_time: 20000.0
    gain: 200.0
    frame_rate: 30.0
    width: 2592
    height: 1944
```

### 角度精度處理
```python
# 角度存儲到寄存器
angle_int = int(angle)           # 整數部分
angle_decimal = int((angle - angle_int) * 100)  # 小數部分×100

# 寄存器恢復角度
final_angle = angle_int + (angle_decimal / 100.0)
```

## 開發計劃

### 實現優先級
1. **Phase 1**: 基礎架構搭建
   - Modbus TCP Client服務
   - 握手協議實現
   - 相機管理整合
   
2. **Phase 2**: 算法整合
   - 角度檢測算法封裝
   - 雙模式支援實現
   - 結果寄存器映射
   
3. **Phase 3**: Web介面開發
   - 基礎控制介面
   - 參數調整功能
   - 結果顯示優化
   
4. **Phase 4**: 測試驗證
   - 功能測試
   - 精度驗證
   - 系統整合測試

### 成功標準
1. **功能完整性**: 所有規格需求實現
2. **握手協議**: 與PLC正常通訊
3. **檢測精度**: 角度檢測準確度符合需求
4. **系統穩定性**: 長時間運行無異常
5. **介面易用性**: Web介面操作便利

## 約束條件

### 技術約束
- **不修改核心算法**: opencv_detect_module.py保持原樣
- **寄存器限制**: 使用800-899地址範圍
- **精度限制**: 角度保留2位小數精度

### 硬體約束
- **相機型號**: 海康威視相機
- **網路配置**: 192.168.1.10固定IP
- **處理性能**: 檢測時間控制在合理範圍

### 相容性約束
- **專案架構**: 遵循既有模組設計模式
- **Python版本**: 兼容現有Python環境
- **依賴版本**: 與其他模組依賴版本一致

## 驗收標準

### 功能驗收
1. **拍照功能**: 相機正常捕獲圖像
2. **角度檢測**: 兩種模式都能正確檢測ring物件角度
3. **握手協議**: PLC可正常控制模組執行
4. **Web介面**: 所有控制功能正常運作
5. **寄存器通訊**: 數值讀寫正確無誤

### 性能驗收
1. **檢測時間**: 單次檢測時間<5秒
2. **角度精度**: 檢測誤差<0.5度
3. **系統穩定性**: 連續運行24小時無異常
4. **響應時間**: Web介面響應<1秒

### 文檔驗收
1. **技術文檔**: 完整的CCD3技術文檔
2. **操作說明**: 清晰的使用說明
3. **API文檔**: 完整的寄存器說明
4. **錯誤處理**: 異常情況處理說明

---

**文檔版本**: v1.0  
**創建日期**: 2024-12-XX  
**最後更新**: 2024-12-XX  
**負責人**: 開發團隊