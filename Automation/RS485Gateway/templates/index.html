<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS485 Gateway 測試控制台</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .device-panel { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .device-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .control-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .control-item { padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa; }
        .control-item label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        .control-item input, .control-item select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; margin: 5px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }
        .status-panel { background: #ecf0f1; padding: 15px; border-radius: 6px; margin-top: 15px; }
        .status-item { margin: 5px 0; padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #3498db; }
        .log-panel { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 6px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 20px; }
        .connection-status { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .connected { background: #27ae60; color: white; }
        .disconnected { background: #e74c3c; color: white; }
        .testing { background: #f39c12; color: white; }
        .pghl-controls { display: none; }
        .show-pghl .pghl-controls { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 RS485 Gateway 測試控制台</h1>
            <div>
                Gateway狀態: <span id="gatewayStatus" class="connection-status disconnected">未連接</span>
                <button id="connectBtn" class="btn btn-success" onclick="connectGateway()">連接Gateway</button>
                <button id="disconnectBtn" class="btn btn-danger" onclick="disconnectGateway()">斷開Gateway</button>
            </div>
        </div>

        <!-- PGC 控制面板 -->
        <div class="device-panel">
            <div class="device-title">PGC - 協作型平行電爪 (Slave ID: 6)</div>
            
            <div class="control-group">
                <div class="control-item">
                    <label>初始化模式</label>
                    <select id="pgc-init-mode">
                        <option value="1">回零位</option>
                        <option value="165">重新標定 (0xA5)</option>
                    </select>
                    <button class="btn btn-primary" onclick="initializeGripper('PGC')">初始化</button>
                </div>
                
                <div class="control-item">
                    <label>力值設定 (20-100%)</label>
                    <input type="number" id="pgc-force" min="20" max="100" value="50">
                    <button class="btn btn-warning" onclick="setForce('PGC')">設定力值</button>
                </div>
                
                <div class="control-item">
                    <label>位置設定 (0-1000)</label>
                    <input type="number" id="pgc-position" min="0" max="1000" value="500">
                    <button class="btn btn-info" onclick="setPosition('PGC')">設定位置</button>
                </div>
                
                <div class="control-item">
                    <label>速度設定 (1-100%)</label>
                    <input type="number" id="pgc-speed" min="1" max="100" value="50">
                    <button class="btn btn-info" onclick="setSpeed('PGC')">設定速度</button>
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-item">
                    <button class="btn btn-success" onclick="openGripper('PGC')">張開夾爪</button>
                    <button class="btn btn-danger" onclick="closeGripper('PGC')">閉合夾爪</button>
                    <button class="btn btn-warning" onclick="stopGripper('PGC')">停止夾爪</button>
                </div>
                
                <div class="control-item">
                    <button class="btn btn-info" onclick="getStatus('PGC')">獲取狀態</button>
                    <button class="btn btn-primary" onclick="saveParameters('PGC')">保存參數</button>
                </div>
            </div>
            
            <div class="status-panel" id="pgc-status">
                <h4>PGC 狀態回饋</h4>
                <div id="pgc-status-content">點擊「獲取狀態」查看即時資訊</div>
            </div>
        </div>

        <!-- PGE 控制面板 -->
        <div class="device-panel">
            <div class="device-title">PGE - 工業型平行電爪 (Slave ID: 4)</div>
            
            <div class="control-group">
                <div class="control-item">
                    <label>初始化模式</label>
                    <select id="pge-init-mode">
                        <option value="1">回零位</option>
                        <option value="165">重新標定 (0xA5)</option>
                    </select>
                    <button class="btn btn-primary" onclick="initializeGripper('PGE')">初始化</button>
                </div>
                
                <div class="control-item">
                    <label>力值設定 (20-100%)</label>
                    <input type="number" id="pge-force" min="20" max="100" value="50">
                    <button class="btn btn-warning" onclick="setForce('PGE')">設定力值</button>
                </div>
                
                <div class="control-item">
                    <label>位置設定 (0-1000)</label>
                    <input type="number" id="pge-position" min="0" max="1000" value="500">
                    <button class="btn btn-info" onclick="setPosition('PGE')">設定位置</button>
                </div>
                
                <div class="control-item">
                    <label>速度設定 (1-100%)</label>
                    <input type="number" id="pge-speed" min="1" max="100" value="50">
                    <button class="btn btn-info" onclick="setSpeed('PGE')">設定速度</button>
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-item">
                    <button class="btn btn-success" onclick="openGripper('PGE')">張開夾爪</button>
                    <button class="btn btn-danger" onclick="closeGripper('PGE')">閉合夾爪</button>
                    <button class="btn btn-warning" onclick="stopGripper('PGE')">停止夾爪</button>
                </div>
                
                <div class="control-item">
                    <button class="btn btn-info" onclick="getStatus('PGE')">獲取狀態</button>
                    <button class="btn btn-primary" onclick="saveParameters('PGE')">保存參數</button>
                </div>
                
                <div class="control-item">
                    <label>自動初始化</label>
                    <button class="btn btn-success" onclick="setAutoInit(true)">啟用</button>
                    <button class="btn btn-danger" onclick="setAutoInit(false)">停用</button>
                </div>
            </div>
            
            <div class="status-panel" id="pge-status">
                <h4>PGE 狀態回饋</h4>
                <div id="pge-status-content">點擊「獲取狀態」查看即時資訊</div>
            </div>
        </div>

        <!-- PGHL 控制面板 -->
        <div class="device-panel">
            <div class="device-title">PGHL - 待實作型號 (Slave ID: 5)</div>
            
            <div class="control-group">
                <div class="control-item">
                    <label>初始化模式</label>
                    <select id="pghl-init-mode">
                        <option value="1">回零位</option>
                        <option value="165">重新標定 (0xA5)</option>
                    </select>
                    <button class="btn btn-primary" onclick="initializeGripper('PGHL')">初始化</button>
                </div>
                
                <div class="control-item">
                    <label>力值設定 (20-100%)</label>
                    <input type="number" id="pghl-force" min="20" max="100" value="50">
                    <button class="btn btn-warning" onclick="setForce('PGHL')">設定力值</button>
                </div>
                
                <div class="control-item">
                    <label>位置設定 (0-1000)</label>
                    <input type="number" id="pghl-position" min="0" max="1000" value="500">
                    <button class="btn btn-info" onclick="setPosition('PGHL')">設定位置</button>
                </div>
                
                <div class="control-item">
                    <label>速度設定 (1-100%)</label>
                    <input type="number" id="pghl-speed" min="1" max="100" value="50">
                    <button class="btn btn-info" onclick="setSpeed('PGHL')">設定速度</button>
                </div>
            </div>
            
            <!-- PGHL 特有控制 -->
            <div class="pghl-controls">
                <div class="control-group">
                    <div class="control-item">
                        <label>推壓段長度 (0-65535, 單位0.01mm)</label>
                        <input type="number" id="pghl-push-segment" min="0" max="65535" value="1000">
                        <button class="btn btn-info" onclick="setPushSegment()">設定推壓段</button>
                    </div>
                    
                    <div class="control-item">
                        <label>加/減速度 (1-100%)</label>
                        <input type="number" id="pghl-acceleration" min="1" max="100" value="50">
                        <button class="btn btn-info" onclick="setAcceleration()">設定加速度</button>
                    </div>
                    
                    <div class="control-item">
                        <label>相對位置 (-32767 ~ 32767)</label>
                        <input type="number" id="pghl-relative-pos" min="-32767" max="32767" value="0">
                        <button class="btn btn-info" onclick="setRelativePosition()">設定相對位置</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-item">
                        <label>點動控制</label>
                        <button class="btn btn-success" onclick="jogControl(1)">點動張開</button>
                        <button class="btn btn-warning" onclick="jogControl(0)">點動停止</button>
                        <button class="btn btn-danger" onclick="jogControl(-1)">點動閉合</button>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-item">
                    <button class="btn btn-success" onclick="openGripper('PGHL')">張開夾爪</button>
                    <button class="btn btn-danger" onclick="closeGripper('PGHL')">閉合夾爪</button>
                    <button class="btn btn-warning" onclick="stopGripper('PGHL')">停止夾爪</button>
                </div>
                
                <div class="control-item">
                    <button class="btn btn-info" onclick="getStatus('PGHL')">獲取狀態</button>
                    <button class="btn btn-primary" onclick="saveParameters('PGHL')">保存參數</button>
                </div>
            </div>
            
            <div class="status-panel" id="pghl-status">
                <h4>PGHL 狀態回饋</h4>
                <div id="pghl-status-content">點擊「獲取狀態」查看即時資訊</div>
            </div>
        </div>

        <!-- 日誌面板 -->
        <div class="log-panel" id="logPanel">
            <strong>📋 操作日誌</strong><br>
            系統就緒，等待操作...
        </div>
    </div>

    <script>
        let gatewayConnected = false;

        // 日誌功能
        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logPanel.innerHTML += logEntry;
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // API 請求封裝
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                log(`🔄 發送請求: ${method} /api/gateway/${endpoint}`);
                const response = await fetch(`/api/gateway/${endpoint}`, options);
                const result = await response.json();
                
                if (result.success) {
                    log(`✅ ${result.message || '操作成功'}`, 'success');
                } else {
                    log(`❌ ${result.message || '操作失敗'}`, 'error');
                }
                
                return result;
            } catch (error) {
                log(`🚫 請求失敗: ${error.message}`, 'error');
                return { success: false, message: error.message };
            }
        }

        // Gateway 連接管理
        async function connectGateway() {
            updateConnectionStatus('testing');
            const result = await apiRequest('connect', 'POST');
            gatewayConnected = result.success;
            updateConnectionStatus(gatewayConnected ? 'connected' : 'disconnected');
        }

        async function disconnectGateway() {
            const result = await apiRequest('disconnect', 'POST');
            gatewayConnected = false;
            updateConnectionStatus('disconnected');
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('gatewayStatus');
            statusEl.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    statusEl.textContent = '已連接';
                    break;
                case 'disconnected':
                    statusEl.textContent = '未連接';
                    break;
                case 'testing':
                    statusEl.textContent = '連接中...';
                    break;
            }
        }

        // 夾爪控制函式
        async function initializeGripper(deviceType) {
            const mode = document.getElementById(`${deviceType.toLowerCase()}-init-mode`).value;
            await apiRequest(`gripper/${deviceType}/initialize`, 'POST', { mode: parseInt(mode) });
        }

        async function setForce(deviceType) {
            const force = document.getElementById(`${deviceType.toLowerCase()}-force`).value;
            await apiRequest(`gripper/${deviceType}/force`, 'POST', { force: parseInt(force) });
        }

        async function setPosition(deviceType) {
            const position = document.getElementById(`${deviceType.toLowerCase()}-position`).value;
            await apiRequest(`gripper/${deviceType}/position`, 'POST', { position: parseInt(position) });
        }

        async function setSpeed(deviceType) {
            const speed = document.getElementById(`${deviceType.toLowerCase()}-speed`).value;
            await apiRequest(`gripper/${deviceType}/speed`, 'POST', { speed: parseInt(speed) });
        }

        async function openGripper(deviceType) {
            await apiRequest(`gripper/${deviceType}/open`, 'POST');
        }

        async function closeGripper(deviceType) {
            await apiRequest(`gripper/${deviceType}/close`, 'POST');
        }

        async function stopGripper(deviceType) {
            await apiRequest(`gripper/${deviceType}/stop`, 'POST');
        }

        async function saveParameters(deviceType) {
            await apiRequest(`gripper/${deviceType}/save`, 'POST');
        }

        async function getStatus(deviceType) {
            const result = await apiRequest(`gripper/${deviceType}/status`, 'GET');
            if (result.success !== false) {
                updateStatusDisplay(deviceType, result);
            }
        }

        function updateStatusDisplay(deviceType, statusData) {
            const statusContent = document.getElementById(`${deviceType.toLowerCase()}-status-content`);
            
            let html = '<div class="status-item">';
            
            if (statusData.init_status) {
                const initStatusText = {
                    0: '未初始化',
                    1: '初始化成功',
                    2: '初始化中'
                };
                html += `<strong>初始化狀態:</strong> ${initStatusText[statusData.init_status.value] || statusData.init_status.value}<br>`;
            }
            
            if (statusData.grip_status) {
                const gripStatusText = {
                    0: '運動中',
                    1: '到達位置',
                    2: '夾住物體',
                    3: '物體掉落'
                };
                html += `<strong>夾持狀態:</strong> ${gripStatusText[statusData.grip_status.value] || statusData.grip_status.value}<br>`;
            }
            
            if (statusData.position) {
                html += `<strong>當前位置:</strong> ${statusData.position.value}/1000<br>`;
            }
            
            html += '</div>';
            statusContent.innerHTML = html;
        }

        // PGE 特有功能
        async function setAutoInit(enabled) {
            await apiRequest('gripper/pge/auto_init', 'POST', { auto_init: enabled });
        }

        // PGHL 特有功能
        async function setPushSegment() {
            const length = document.getElementById('pghl-push-segment').value;
            await apiRequest('gripper/PGHL/push_segment', 'POST', { length: parseInt(length) });
        }

        async function setAcceleration() {
            const acceleration = document.getElementById('pghl-acceleration').value;
            await apiRequest('gripper/PGHL/acceleration', 'POST', { acceleration: parseInt(acceleration) });
        }

        async function setRelativePosition() {
            const relativePos = document.getElementById('pghl-relative-pos').value;
            await apiRequest('gripper/PGHL/relative_position', 'POST', { relative_pos: parseInt(relativePos) });
        }

        async function jogControl(direction) {
            await apiRequest('gripper/PGHL/jog', 'POST', { direction: direction });
        }

        // 頁面載入時檢查Gateway狀態
        window.onload = async function() {
            log('🌐 Web UI 已載入');
            
            // 檢查Gateway健康狀態
            try {
                const health = await apiRequest('health', 'GET');
                if (health.connected) {
                    gatewayConnected = true;
                    updateConnectionStatus('connected');
                    log('🔗 Gateway已連接');
                } else {
                    updateConnectionStatus('disconnected');
                    log('⚠️ Gateway未連接到RS485');
                }
            } catch (error) {
                updateConnectionStatus('disconnected');
                log('⚠️ 無法連接到Gateway伺服器');
            }
        };
    </script>
</body>
</html>