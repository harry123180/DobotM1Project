<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS485 Gateway æ¸¬è©¦æ§åˆ¶å°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .device-panel { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .device-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .control-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .control-item { padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa; }
        .control-item label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        .control-item input, .control-item select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; margin: 5px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }
        .status-panel { background: #ecf0f1; padding: 15px; border-radius: 6px; margin-top: 15px; }
        .status-item { margin: 5px 0; padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #3498db; }
        .log-panel { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 6px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 20px; }
        .connection-status { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .connected { background: #27ae60; color: white; }
        .disconnected { background: #e74c3c; color: white; }
        .testing { background: #f39c12; color: white; }
        .pghl-controls { display: none; }
        .show-pghl .pghl-controls { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– RS485 Gateway æ¸¬è©¦æ§åˆ¶å°</h1>
            <div>
                Gatewayç‹€æ…‹: <span id="gatewayStatus" class="connection-status disconnected">æœªé€£æ¥</span>
                <button id="connectBtn" class="btn btn-success" onclick="connectGateway()">é€£æ¥Gateway</button>
                <button id="disconnectBtn" class="btn btn-danger" onclick="disconnectGateway()">æ–·é–‹Gateway</button>
            </div>
        </div>

        <!-- PGC æ§åˆ¶é¢æ¿ -->
        <div class="device-panel">
            <div class="device-title">PGC - å”ä½œå‹å¹³è¡Œé›»çˆª (Slave ID: 6)</div>
            
            <div class="control-group">
                <div class="control-item">
                    <label>åˆå§‹åŒ–æ¨¡å¼</label>
                    <select id="pgc-init-mode">
                        <option value="1">å›é›¶ä½</option>
                        <option value="165">é‡æ–°æ¨™å®š (0xA5)</option>
                    </select>
                    <button class="btn btn-primary" onclick="initializeGripper('PGC')">åˆå§‹åŒ–</button>
                </div>
                
                <div class="control-item">
                    <label>åŠ›å€¼è¨­å®š (20-100%)</label>
                    <input type="number" id="pgc-force" min="20" max="100" value="50">
                    <button class="btn btn-warning" onclick="setForce('PGC')">è¨­å®šåŠ›å€¼</button>
                </div>
                
                <div class="control-item">
                    <label>ä½ç½®è¨­å®š (0-1000)</label>
                    <input type="number" id="pgc-position" min="0" max="1000" value="500">
                    <button class="btn btn-info" onclick="setPosition('PGC')">è¨­å®šä½ç½®</button>
                </div>
                
                <div class="control-item">
                    <label>é€Ÿåº¦è¨­å®š (1-100%)</label>
                    <input type="number" id="pgc-speed" min="1" max="100" value="50">
                    <button class="btn btn-info" onclick="setSpeed('PGC')">è¨­å®šé€Ÿåº¦</button>
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-item">
                    <button class="btn btn-success" onclick="openGripper('PGC')">å¼µé–‹å¤¾çˆª</button>
                    <button class="btn btn-danger" onclick="closeGripper('PGC')">é–‰åˆå¤¾çˆª</button>
                    <button class="btn btn-warning" onclick="stopGripper('PGC')">åœæ­¢å¤¾çˆª</button>
                </div>
                
                <div class="control-item">
                    <button class="btn btn-info" onclick="getStatus('PGC')">ç²å–ç‹€æ…‹</button>
                    <button class="btn btn-primary" onclick="saveParameters('PGC')">ä¿å­˜åƒæ•¸</button>
                </div>
            </div>
            
            <div class="status-panel" id="pgc-status">
                <h4>PGC ç‹€æ…‹å›é¥‹</h4>
                <div id="pgc-status-content">é»æ“Šã€Œç²å–ç‹€æ…‹ã€æŸ¥çœ‹å³æ™‚è³‡è¨Š</div>
            </div>
        </div>

        <!-- PGE æ§åˆ¶é¢æ¿ -->
        <div class="device-panel">
            <div class="device-title">PGE - å·¥æ¥­å‹å¹³è¡Œé›»çˆª (Slave ID: 4)</div>
            
            <div class="control-group">
                <div class="control-item">
                    <label>åˆå§‹åŒ–æ¨¡å¼</label>
                    <select id="pge-init-mode">
                        <option value="1">å›é›¶ä½</option>
                        <option value="165">é‡æ–°æ¨™å®š (0xA5)</option>
                    </select>
                    <button class="btn btn-primary" onclick="initializeGripper('PGE')">åˆå§‹åŒ–</button>
                </div>
                
                <div class="control-item">
                    <label>åŠ›å€¼è¨­å®š (20-100%)</label>
                    <input type="number" id="pge-force" min="20" max="100" value="50">
                    <button class="btn btn-warning" onclick="setForce('PGE')">è¨­å®šåŠ›å€¼</button>
                </div>
                
                <div class="control-item">
                    <label>ä½ç½®è¨­å®š (0-1000)</label>
                    <input type="number" id="pge-position" min="0" max="1000" value="500">
                    <button class="btn btn-info" onclick="setPosition('PGE')">è¨­å®šä½ç½®</button>
                </div>
                
                <div class="control-item">
                    <label>é€Ÿåº¦è¨­å®š (1-100%)</label>
                    <input type="number" id="pge-speed" min="1" max="100" value="50">
                    <button class="btn btn-info" onclick="setSpeed('PGE')">è¨­å®šé€Ÿåº¦</button>
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-item">
                    <button class="btn btn-success" onclick="openGripper('PGE')">å¼µé–‹å¤¾çˆª</button>
                    <button class="btn btn-danger" onclick="closeGripper('PGE')">é–‰åˆå¤¾çˆª</button>
                    <button class="btn btn-warning" onclick="stopGripper('PGE')">åœæ­¢å¤¾çˆª</button>
                </div>
                
                <div class="control-item">
                    <button class="btn btn-info" onclick="getStatus('PGE')">ç²å–ç‹€æ…‹</button>
                    <button class="btn btn-primary" onclick="saveParameters('PGE')">ä¿å­˜åƒæ•¸</button>
                </div>
                
                <div class="control-item">
                    <label>è‡ªå‹•åˆå§‹åŒ–</label>
                    <button class="btn btn-success" onclick="setAutoInit(true)">å•Ÿç”¨</button>
                    <button class="btn btn-danger" onclick="setAutoInit(false)">åœç”¨</button>
                </div>
            </div>
            
            <div class="status-panel" id="pge-status">
                <h4>PGE ç‹€æ…‹å›é¥‹</h4>
                <div id="pge-status-content">é»æ“Šã€Œç²å–ç‹€æ…‹ã€æŸ¥çœ‹å³æ™‚è³‡è¨Š</div>
            </div>
        </div>

        <!-- PGHL æ§åˆ¶é¢æ¿ -->
        <div class="device-panel">
            <div class="device-title">PGHL - å¾…å¯¦ä½œå‹è™Ÿ (Slave ID: 5)</div>
            
            <div class="control-group">
                <div class="control-item">
                    <label>åˆå§‹åŒ–æ¨¡å¼</label>
                    <select id="pghl-init-mode">
                        <option value="1">å›é›¶ä½</option>
                        <option value="165">é‡æ–°æ¨™å®š (0xA5)</option>
                    </select>
                    <button class="btn btn-primary" onclick="initializeGripper('PGHL')">åˆå§‹åŒ–</button>
                </div>
                
                <div class="control-item">
                    <label>åŠ›å€¼è¨­å®š (20-100%)</label>
                    <input type="number" id="pghl-force" min="20" max="100" value="50">
                    <button class="btn btn-warning" onclick="setForce('PGHL')">è¨­å®šåŠ›å€¼</button>
                </div>
                
                <div class="control-item">
                    <label>ä½ç½®è¨­å®š (0-1000)</label>
                    <input type="number" id="pghl-position" min="0" max="1000" value="500">
                    <button class="btn btn-info" onclick="setPosition('PGHL')">è¨­å®šä½ç½®</button>
                </div>
                
                <div class="control-item">
                    <label>é€Ÿåº¦è¨­å®š (1-100%)</label>
                    <input type="number" id="pghl-speed" min="1" max="100" value="50">
                    <button class="btn btn-info" onclick="setSpeed('PGHL')">è¨­å®šé€Ÿåº¦</button>
                </div>
            </div>
            
            <!-- PGHL ç‰¹æœ‰æ§åˆ¶ -->
            <div class="pghl-controls">
                <div class="control-group">
                    <div class="control-item">
                        <label>æ¨å£“æ®µé•·åº¦ (0-65535, å–®ä½0.01mm)</label>
                        <input type="number" id="pghl-push-segment" min="0" max="65535" value="1000">
                        <button class="btn btn-info" onclick="setPushSegment()">è¨­å®šæ¨å£“æ®µ</button>
                    </div>
                    
                    <div class="control-item">
                        <label>åŠ /æ¸›é€Ÿåº¦ (1-100%)</label>
                        <input type="number" id="pghl-acceleration" min="1" max="100" value="50">
                        <button class="btn btn-info" onclick="setAcceleration()">è¨­å®šåŠ é€Ÿåº¦</button>
                    </div>
                    
                    <div class="control-item">
                        <label>ç›¸å°ä½ç½® (-32767 ~ 32767)</label>
                        <input type="number" id="pghl-relative-pos" min="-32767" max="32767" value="0">
                        <button class="btn btn-info" onclick="setRelativePosition()">è¨­å®šç›¸å°ä½ç½®</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-item">
                        <label>é»å‹•æ§åˆ¶</label>
                        <button class="btn btn-success" onclick="jogControl(1)">é»å‹•å¼µé–‹</button>
                        <button class="btn btn-warning" onclick="jogControl(0)">é»å‹•åœæ­¢</button>
                        <button class="btn btn-danger" onclick="jogControl(-1)">é»å‹•é–‰åˆ</button>
                    </div>
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-item">
                    <button class="btn btn-success" onclick="openGripper('PGHL')">å¼µé–‹å¤¾çˆª</button>
                    <button class="btn btn-danger" onclick="closeGripper('PGHL')">é–‰åˆå¤¾çˆª</button>
                    <button class="btn btn-warning" onclick="stopGripper('PGHL')">åœæ­¢å¤¾çˆª</button>
                </div>
                
                <div class="control-item">
                    <button class="btn btn-info" onclick="getStatus('PGHL')">ç²å–ç‹€æ…‹</button>
                    <button class="btn btn-primary" onclick="saveParameters('PGHL')">ä¿å­˜åƒæ•¸</button>
                </div>
            </div>
            
            <div class="status-panel" id="pghl-status">
                <h4>PGHL ç‹€æ…‹å›é¥‹</h4>
                <div id="pghl-status-content">é»æ“Šã€Œç²å–ç‹€æ…‹ã€æŸ¥çœ‹å³æ™‚è³‡è¨Š</div>
            </div>
        </div>

        <!-- æ—¥èªŒé¢æ¿ -->
        <div class="log-panel" id="logPanel">
            <strong>ğŸ“‹ æ“ä½œæ—¥èªŒ</strong><br>
            ç³»çµ±å°±ç·’ï¼Œç­‰å¾…æ“ä½œ...
        </div>
    </div>

    <script>
        let gatewayConnected = false;

        // æ—¥èªŒåŠŸèƒ½
        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logPanel.innerHTML += logEntry;
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // API è«‹æ±‚å°è£
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                log(`ğŸ”„ ç™¼é€è«‹æ±‚: ${method} /api/gateway/${endpoint}`);
                const response = await fetch(`/api/gateway/${endpoint}`, options);
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ… ${result.message || 'æ“ä½œæˆåŠŸ'}`, 'success');
                } else {
                    log(`âŒ ${result.message || 'æ“ä½œå¤±æ•—'}`, 'error');
                }
                
                return result;
            } catch (error) {
                log(`ğŸš« è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
                return { success: false, message: error.message };
            }
        }

        // Gateway é€£æ¥ç®¡ç†
        async function connectGateway() {
            updateConnectionStatus('testing');
            const result = await apiRequest('connect', 'POST');
            gatewayConnected = result.success;
            updateConnectionStatus(gatewayConnected ? 'connected' : 'disconnected');
        }

        async function disconnectGateway() {
            const result = await apiRequest('disconnect', 'POST');
            gatewayConnected = false;
            updateConnectionStatus('disconnected');
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('gatewayStatus');
            statusEl.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    statusEl.textContent = 'å·²é€£æ¥';
                    break;
                case 'disconnected':
                    statusEl.textContent = 'æœªé€£æ¥';
                    break;
                case 'testing':
                    statusEl.textContent = 'é€£æ¥ä¸­...';
                    break;
            }
        }

        // å¤¾çˆªæ§åˆ¶å‡½å¼
        async function initializeGripper(deviceType) {
            const mode = document.getElementById(`${deviceType.toLowerCase()}-init-mode`).value;
            await apiRequest(`gripper/${deviceType}/initialize`, 'POST', { mode: parseInt(mode) });
        }

        async function setForce(deviceType) {
            const force = document.getElementById(`${deviceType.toLowerCase()}-force`).value;
            await apiRequest(`gripper/${deviceType}/force`, 'POST', { force: parseInt(force) });
        }

        async function setPosition(deviceType) {
            const position = document.getElementById(`${deviceType.toLowerCase()}-position`).value;
            await apiRequest(`gripper/${deviceType}/position`, 'POST', { position: parseInt(position) });
        }

        async function setSpeed(deviceType) {
            const speed = document.getElementById(`${deviceType.toLowerCase()}-speed`).value;
            await apiRequest(`gripper/${deviceType}/speed`, 'POST', { speed: parseInt(speed) });
        }

        async function openGripper(deviceType) {
            await apiRequest(`gripper/${deviceType}/open`, 'POST');
        }

        async function closeGripper(deviceType) {
            await apiRequest(`gripper/${deviceType}/close`, 'POST');
        }

        async function stopGripper(deviceType) {
            await apiRequest(`gripper/${deviceType}/stop`, 'POST');
        }

        async function saveParameters(deviceType) {
            await apiRequest(`gripper/${deviceType}/save`, 'POST');
        }

        async function getStatus(deviceType) {
            const result = await apiRequest(`gripper/${deviceType}/status`, 'GET');
            if (result.success !== false) {
                updateStatusDisplay(deviceType, result);
            }
        }

        function updateStatusDisplay(deviceType, statusData) {
            const statusContent = document.getElementById(`${deviceType.toLowerCase()}-status-content`);
            
            let html = '<div class="status-item">';
            
            if (statusData.init_status) {
                const initStatusText = {
                    0: 'æœªåˆå§‹åŒ–',
                    1: 'åˆå§‹åŒ–æˆåŠŸ',
                    2: 'åˆå§‹åŒ–ä¸­'
                };
                html += `<strong>åˆå§‹åŒ–ç‹€æ…‹:</strong> ${initStatusText[statusData.init_status.value] || statusData.init_status.value}<br>`;
            }
            
            if (statusData.grip_status) {
                const gripStatusText = {
                    0: 'é‹å‹•ä¸­',
                    1: 'åˆ°é”ä½ç½®',
                    2: 'å¤¾ä½ç‰©é«”',
                    3: 'ç‰©é«”æ‰è½'
                };
                html += `<strong>å¤¾æŒç‹€æ…‹:</strong> ${gripStatusText[statusData.grip_status.value] || statusData.grip_status.value}<br>`;
            }
            
            if (statusData.position) {
                html += `<strong>ç•¶å‰ä½ç½®:</strong> ${statusData.position.value}/1000<br>`;
            }
            
            html += '</div>';
            statusContent.innerHTML = html;
        }

        // PGE ç‰¹æœ‰åŠŸèƒ½
        async function setAutoInit(enabled) {
            await apiRequest('gripper/pge/auto_init', 'POST', { auto_init: enabled });
        }

        // PGHL ç‰¹æœ‰åŠŸèƒ½
        async function setPushSegment() {
            const length = document.getElementById('pghl-push-segment').value;
            await apiRequest('gripper/PGHL/push_segment', 'POST', { length: parseInt(length) });
        }

        async function setAcceleration() {
            const acceleration = document.getElementById('pghl-acceleration').value;
            await apiRequest('gripper/PGHL/acceleration', 'POST', { acceleration: parseInt(acceleration) });
        }

        async function setRelativePosition() {
            const relativePos = document.getElementById('pghl-relative-pos').value;
            await apiRequest('gripper/PGHL/relative_position', 'POST', { relative_pos: parseInt(relativePos) });
        }

        async function jogControl(direction) {
            await apiRequest('gripper/PGHL/jog', 'POST', { direction: direction });
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥Gatewayç‹€æ…‹
        window.onload = async function() {
            log('ğŸŒ Web UI å·²è¼‰å…¥');
            
            // æª¢æŸ¥Gatewayå¥åº·ç‹€æ…‹
            try {
                const health = await apiRequest('health', 'GET');
                if (health.connected) {
                    gatewayConnected = true;
                    updateConnectionStatus('connected');
                    log('ğŸ”— Gatewayå·²é€£æ¥');
                } else {
                    updateConnectionStatus('disconnected');
                    log('âš ï¸ Gatewayæœªé€£æ¥åˆ°RS485');
                }
            } catch (error) {
                updateConnectionStatus('disconnected');
                log('âš ï¸ ç„¡æ³•é€£æ¥åˆ°Gatewayä¼ºæœå™¨');
            }
        };
    </script>
</body>
</html>