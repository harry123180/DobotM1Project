# config.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
RS485 Gateway Configuration
===========================
"""

# RS485 é€£æ¥è¨­å®š
RS485_CONFIG = {
    'port': 'COM3',          # RS485ä¸²å£è™Ÿ
    'baudrate': 115200,      # æ³¢ç‰¹ç‡
    'timeout': 1,            # é€šè¨Šè¶…æ™‚æ™‚é–“(ç§’)
    'parity': 'N',           # æ ¡é©—ä½
    'stopbits': 1,           # åœæ­¢ä½
    'bytesize': 8            # æ•¸æ“šä½
}

# Flask ä¼ºæœå™¨è¨­å®š
SERVER_CONFIG = {
    'host': '0.0.0.0',       # ç›£è½IP (0.0.0.0è¡¨ç¤ºæ‰€æœ‰ç¶²å¡)
    'port': 5000,            # ç›£è½ç«¯å£
    'debug': False,          # èª¿è©¦æ¨¡å¼
    'threaded': True         # å¤šç·šç¨‹æ¨¡å¼
}

# è¨­å‚™é…ç½®
DEVICE_CONFIG = {
    'PGC': {
        'slave_id': 6,
        'description': 'å”ä½œå‹å¹³è¡Œé›»çˆª',
        'model_series': ['PGC-50-35', 'PGC-140-50', 'PGC-300-60']
    },
    'PGE': {
        'slave_id': 4,
        'description': 'å·¥æ¥­å‹å¹³è¡Œé›»çˆª',
        'model_series': ['PGE-5-26', 'PGE-8-14', 'PGE-15-26', 'PGE-50-26', 'PGE-100-26']
    },
    'PGHL': {
        'slave_id': 5,
        'description': 'å¾…å¯¦ä½œå‹è™Ÿ',
        'model_series': []  # å¾…PGHLæ‰‹å†Šæä¾›å¾Œæ›´æ–°
    }
}

# æ—¥èªŒè¨­å®š
LOGGING_CONFIG = {
    'level': 'INFO',         # æ—¥èªŒç´šåˆ¥: DEBUG, INFO, WARNING, ERROR
    'format': '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    'file': 'rs485_gateway.log',  # æ—¥èªŒæ–‡ä»¶
    'max_bytes': 10 * 1024 * 1024,  # 10MB
    'backup_count': 3        # ä¿ç•™3å€‹å‚™ä»½æ–‡ä»¶
}

# API ç«¯é»é…ç½®
API_ENDPOINTS = {
    'health': '/health',
    'connect': '/connect',
    'disconnect': '/disconnect',
    'devices': '/devices',
    'gripper_base': '/gripper/{device_type}',
    'status': '/gripper/{device_type}/status',
    'initialize': '/gripper/{device_type}/initialize',
    'force': '/gripper/{device_type}/force',
    'position': '/gripper/{device_type}/position',
    'speed': '/gripper/{device_type}/speed',
    'open': '/gripper/{device_type}/open',
    'close': '/gripper/{device_type}/close',
    'stop': '/gripper/{device_type}/stop',
    'save': '/gripper/{device_type}/save',
    'io_mode': '/gripper/{device_type}/io_mode',
    'io_trigger': '/gripper/{device_type}/io_trigger',
    'auto_init_pge': '/gripper/pge/auto_init'
}

# åƒæ•¸ç¯„åœé©—è­‰
PARAMETER_RANGES = {
    'force': {'min': 20, 'max': 100, 'unit': '%'},
    'position': {'min': 0, 'max': 1000, 'unit': 'â€°'},
    'speed': {'min': 1, 'max': 100, 'unit': '%'},
    'io_group': {'min': 1, 'max': 4, 'unit': ''},
    'init_mode': [1, 0xA5],  # 1: å›é›¶ä½, 0xA5: é‡æ–°æ¨™å®š
    'slave_id': {'min': 1, 'max': 247, 'unit': ''}
}

# Modbus å¯„å­˜å™¨åœ°å€å°ç…§ (16é€²åˆ¶)
MODBUS_REGISTERS = {
    'CONTROL': {
        'INITIALIZE': 0x0100,      # åˆå§‹åŒ–å¤¾çˆª
        'FORCE': 0x0101,           # åŠ›å€¼è¨­å®š
        'POSITION': 0x0103,        # ä½ç½®è¨­å®š
        'SPEED': 0x0104            # é€Ÿåº¦è¨­å®š
    },
    'STATUS': {
        'INIT_STATUS': 0x0200,     # åˆå§‹åŒ–ç‹€æ…‹
        'GRIP_STATUS': 0x0201,     # å¤¾æŒç‹€æ…‹
        'POSITION_FEEDBACK': 0x0202 # ä½ç½®åé¥‹
    },
    'CONFIG': {
        'SAVE_FLASH': 0x0300,      # ä¿å­˜åˆ°Flash
        'INIT_DIRECTION': 0x0301,  # åˆå§‹åŒ–æ–¹å‘
        'DEVICE_ID': 0x0302,       # è¨­å‚™ID
        'BAUDRATE': 0x0303,        # æ³¢ç‰¹ç‡
        'STOPBITS': 0x0304,        # åœæ­¢ä½
        'PARITY': 0x0305,          # æ ¡é©—ä½
        'IO_TEST': 0x0400,         # IOåƒæ•¸æ¸¬è©¦
        'IO_MODE': 0x0402,         # IOæ¨¡å¼é–‹é—œ
        'IO_CONFIG_START': 0x0405, # IOåƒæ•¸é…ç½®èµ·å§‹åœ°å€
        'IO_CONFIG_END': 0x0410,   # IOåƒæ•¸é…ç½®çµæŸåœ°å€
        'AUTO_INIT_PGE': 0x0504    # PGEè‡ªå‹•åˆå§‹åŒ– (åƒ…PGE)
    }
}

# ç‹€æ…‹ç¢¼å®šç¾©
STATUS_CODES = {
    'INIT_STATUS': {
        0: 'æœªåˆå§‹åŒ–',
        1: 'åˆå§‹åŒ–æˆåŠŸ',
        2: 'åˆå§‹åŒ–ä¸­'  # åƒ…PGE
    },
    'GRIP_STATUS': {
        0: 'é‹å‹•ä¸­',
        1: 'åˆ°é”ä½ç½®',
        2: 'å¤¾ä½ç‰©é«”',
        3: 'ç‰©é«”æ‰è½'
    },
    'IO_MODE': {
        0: 'é—œé–‰',
        1: 'é–‹å•Ÿ'
    },
    'INIT_MODE': {
        1: 'å›é›¶ä½(å–®å‘åˆå§‹åŒ–)',
        0xA5: 'å®Œå…¨åˆå§‹åŒ–(é‡æ–°æ¨™å®š)'
    }
}

# é è¨­åƒæ•¸çµ„åˆ
DEFAULT_PRESETS = {
    'gentle_grip': {
        'force': 30,
        'speed': 40,
        'description': 'è¼•æŸ”å¤¾æŒ - é©åˆæ˜“ç¢ç‰©å“'
    },
    'normal_grip': {
        'force': 50,
        'speed': 60,
        'description': 'æ­£å¸¸å¤¾æŒ - ä¸€èˆ¬ç”¨é€”'
    },
    'strong_grip': {
        'force': 80,
        'speed': 80,
        'description': 'å¼·åŠ›å¤¾æŒ - é‡ç‰©æˆ–ç‰¢å›ºå¤¾æŒ'
    },
    'fast_movement': {
        'force': 60,
        'speed': 90,
        'description': 'å¿«é€Ÿç§»å‹• - é«˜æ•ˆç‡ä½œæ¥­'
    },
    'precise_movement': {
        'force': 40,
        'speed': 20,
        'description': 'ç²¾å¯†ç§»å‹• - é«˜ç²¾åº¦å®šä½'
    }
}

# éŒ¯èª¤ç¢¼å®šç¾©
ERROR_CODES = {
    'E001': 'RS485é€£æ¥å¤±æ•—',
    'E002': 'è¨­å‚™é¡å‹ä¸æ”¯æ´',
    'E003': 'åƒæ•¸è¶…å‡ºç¯„åœ',
    'E004': 'Modbusé€šè¨ŠéŒ¯èª¤',
    'E005': 'è¨­å‚™æœªåˆå§‹åŒ–',
    'E006': 'IOæ¨¡å¼æœªå•Ÿç”¨',
    'E007': 'æ“ä½œè¶…æ™‚',
    'E008': 'JSONæ ¼å¼éŒ¯èª¤',
    'E009': 'ç¼ºå°‘å¿…è¦åƒæ•¸',
    'E010': 'è¨­å‚™å¿™ç¢Œä¸­'
}

# ===============================================
# start_gateway.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
RS485 Gateway Startup Script
============================

å¿«é€Ÿå•Ÿå‹•RS485 Gatewayä¼ºæœå™¨çš„è…³æœ¬
"""

import sys
import os
import argparse
import logging.handlers
from config import *

def setup_logging():
    """è¨­å®šæ—¥èªŒç³»çµ±"""
    # å»ºç«‹logger
    logger = logging.getLogger()
    logger.setLevel(getattr(logging, LOGGING_CONFIG['level']))
    
    # è¨­å®šæ ¼å¼
    formatter = logging.Formatter(LOGGING_CONFIG['format'])
    
    # æ§åˆ¶å°è™•ç†å™¨
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(logging.INFO)
    console_handler.setFormatter(formatter)
    logger.addHandler(console_handler)
    
    # æ–‡ä»¶è™•ç†å™¨ (è¼ªæ›¿æ—¥èªŒ)
    file_handler = logging.handlers.RotatingFileHandler(
        LOGGING_CONFIG['file'],
        maxBytes=LOGGING_CONFIG['max_bytes'],
        backupCount=LOGGING_CONFIG['backup_count'],
        encoding='utf-8'
    )
    file_handler.setLevel(logging.DEBUG)
    file_handler.setFormatter(formatter)
    logger.addHandler(file_handler)
    
    return logger

def parse_arguments():
    """è§£æå‘½ä»¤è¡Œåƒæ•¸"""
    parser = argparse.ArgumentParser(description='RS485 Gateway Server')
    
    parser.add_argument(
        '--port', '-p',
        default=RS485_CONFIG['port'],
        help=f"RS485ä¸²å£è™Ÿ (é è¨­: {RS485_CONFIG['port']})"
    )
    
    parser.add_argument(
        '--baudrate', '-b',
        type=int,
        default=RS485_CONFIG['baudrate'],
        help=f"æ³¢ç‰¹ç‡ (é è¨­: {RS485_CONFIG['baudrate']})"
    )
    
    parser.add_argument(
        '--server-host',
        default=SERVER_CONFIG['host'],
        help=f"ä¼ºæœå™¨ç›£è½IP (é è¨­: {SERVER_CONFIG['host']})"
    )
    
    parser.add_argument(
        '--server-port',
        type=int,
        default=SERVER_CONFIG['port'],
        help=f"ä¼ºæœå™¨ç›£è½ç«¯å£ (é è¨­: {SERVER_CONFIG['port']})"
    )
    
    parser.add_argument(
        '--debug',
        action='store_true',
        help='å•Ÿç”¨èª¿è©¦æ¨¡å¼'
    )
    
    parser.add_argument(
        '--no-auto-connect',
        action='store_true',
        help='å•Ÿå‹•æ™‚ä¸è‡ªå‹•é€£æ¥RS485'
    )
    
    return parser.parse_args()

def main():
    """ä¸»ç¨‹å¼"""
    # è§£æåƒæ•¸
    args = parse_arguments()
    
    # è¨­å®šæ—¥èªŒ
    logger = setup_logging()
    
    try:
        # å°å…¥Gatewayé¡åˆ¥
        from RS485Gateway import RS485Gateway
        
        # é¡¯ç¤ºå•Ÿå‹•ä¿¡æ¯
        logger.info("=" * 50)
        logger.info("ğŸš€ æ­£åœ¨å•Ÿå‹• RS485 Gateway Server")
        logger.info("=" * 50)
        logger.info(f"RS485ç«¯å£: {args.port}")
        logger.info(f"æ³¢ç‰¹ç‡: {args.baudrate}")
        logger.info(f"ä¼ºæœå™¨: {args.server_host}:{args.server_port}")
        logger.info(f"èª¿è©¦æ¨¡å¼: {'é–‹å•Ÿ' if args.debug else 'é—œé–‰'}")
        logger.info(f"æ”¯æ´è¨­å‚™: {list(DEVICE_CONFIG.keys())}")
        
        # å»ºç«‹Gatewayå¯¦ä¾‹
        gateway = RS485Gateway(
            port=args.port,
            baudrate=args.baudrate,
            timeout=RS485_CONFIG['timeout']
        )
        
        # è‡ªå‹•é€£æ¥RS485 (é™¤éæŒ‡å®šä¸è¦)
        if not args.no_auto_connect:
            logger.info("\nğŸ“¡ æ­£åœ¨é€£æ¥RS485...")
            if gateway.connect():
                logger.info("âœ… RS485é€£æ¥æˆåŠŸ")
            else:
                logger.warning("âš ï¸ RS485é€£æ¥å¤±æ•—ï¼Œä½†ä¼ºæœå™¨ä»æœƒå•Ÿå‹•")
        
        # é¡¯ç¤ºAPIç«¯é»ä¿¡æ¯
        logger.info("\nğŸ“‹ å¯ç”¨çš„APIç«¯é»:")
        logger.info(f"  å¥åº·æª¢æŸ¥: GET  {args.server_host}:{args.server_port}/health")
        logger.info(f"  è¨­å‚™åˆ—è¡¨: GET  {args.server_host}:{args.server_port}/devices")
        logger.info(f"  å¤¾çˆªæ§åˆ¶: POST {args.server_host}:{args.server_port}/gripper/<device_type>/<action>")
        
        # å•Ÿå‹•Flaskä¼ºæœå™¨
        logger.info(f"\nğŸŒ å•Ÿå‹•ä¼ºæœå™¨æ–¼ http://{args.server_host}:{args.server_port}")
        logger.info("æŒ‰ Ctrl+C åœæ­¢ä¼ºæœå™¨\n")
        
        gateway.run_server(
            host=args.server_host,
            port=args.server_port,
            debug=args.debug
        )
        
    except ImportError as e:
        logger.error(f"âŒ æ‰¾ä¸åˆ°RS485Gatewayæ¨¡çµ„: {e}")
        logger.error("è«‹ç¢ºä¿RS485Gateway.pyåœ¨åŒä¸€ç›®éŒ„ä¸‹")
        return 1
        
    except KeyboardInterrupt:
        logger.info("\nğŸ›‘ æ”¶åˆ°ä¸­æ–·ä¿¡è™Ÿï¼Œæ­£åœ¨é—œé–‰...")
        
    except Exception as e:
        logger.error(f"âŒ å•Ÿå‹•å¤±æ•—: {e}")
        return 1
    
    finally:
        # æ¸…ç†è³‡æº
        try:
            if 'gateway' in locals():
                gateway.disconnect()
        except:
            pass
        
        logger.info("ğŸ‘‹ Gatewayå·²åœæ­¢")
    
    return 0

if __name__ == '__main__':
    exit_code = main()
    sys.exit(exit_code)

# ===============================================
# requirements.txt

Flask==2.3.2
pymodbus==3.5.2
requests==2.31.0

# ===============================================
# install_dependencies.py
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å®‰è£ä¾è³´å¥—ä»¶çš„è…³æœ¬
"""

import subprocess
import sys

def install_packages():
    """å®‰è£å¿…è¦çš„Pythonå¥—ä»¶"""
    packages = [
        'Flask==2.3.2',
        'pymodbus==3.5.2', 
        'requests==2.31.0'
    ]
    
    print("ğŸ”§ æ­£åœ¨å®‰è£ä¾è³´å¥—ä»¶...")
    
    for package in packages:
        print(f"å®‰è£ {package}...")
        try:
            subprocess.check_call([sys.executable, '-m', 'pip', 'install', package])
            print(f"âœ… {package} å®‰è£æˆåŠŸ")
        except subprocess.CalledProcessError:
            print(f"âŒ {package} å®‰è£å¤±æ•—")
            return False
    
    print("\nğŸ‰ æ‰€æœ‰å¥—ä»¶å®‰è£å®Œæˆ!")
    return True

if __name__ == '__main__':
    if install_packages():
        print("\nç¾åœ¨å¯ä»¥åŸ·è¡Œ:")
        print("  python start_gateway.py")
        print("æˆ–")  
        print("  python RS485Gateway.py")
    else:
        print("\nâŒ å®‰è£éç¨‹ä¸­å‡ºç¾éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥å’Œpipè¨­å®š")

# ===============================================
# README.md

# RS485 Gateway for DH-Robotics Grippers

é€™æ˜¯ä¸€å€‹ç”¨æ–¼æ§åˆ¶å¤§å¯°æ©Ÿå™¨äºº(DH-Robotics)å¤¾çˆªçš„RS485 Gatewayç³»çµ±ï¼Œè§£æ±ºå¤šå€‹Pythonç¨‹åºåŒæ™‚å­˜å–COMå£çš„å•é¡Œã€‚

## æ”¯æ´è¨­å‚™

- **PGCç³»åˆ—** (å”ä½œå‹å¹³è¡Œé›»çˆª) - Slave ID: 6
- **PGEç³»åˆ—** (å·¥æ¥­å‹å¹³è¡Œé›»çˆª) - Slave ID: 4  
- **PGHLç³»åˆ—** (å¾…å¯¦ä½œ) - Slave ID: 5

## å¿«é€Ÿé–‹å§‹

### 1. å®‰è£ä¾è³´
```bash
python install_dependencies.py
```

### 2. å•Ÿå‹•Gateway
```bash
python start_gateway.py --port COM3 --baudrate 115200
```

### 3. æ¸¬è©¦é€£æ¥
```bash
python client_example.py
```

## APIæ–‡æª”

### åŸºæœ¬ç«¯é»

- `GET /health` - å¥åº·æª¢æŸ¥
- `POST /connect` - é€£æ¥RS485
- `POST /disconnect` - æ–·é–‹RS485
- `GET /devices` - ç²å–æ”¯æ´è¨­å‚™

### å¤¾çˆªæ§åˆ¶

- `POST /gripper/{device_type}/initialize` - åˆå§‹åŒ–
- `POST /gripper/{device_type}/force` - è¨­å®šåŠ›å€¼
- `POST /gripper/{device_type}/position` - è¨­å®šä½ç½®
- `POST /gripper/{device_type}/speed` - è¨­å®šé€Ÿåº¦
- `POST /gripper/{device_type}/open` - å¼µé–‹å¤¾çˆª
- `POST /gripper/{device_type}/close` - é–‰åˆå¤¾çˆª
- `GET /gripper/{device_type}/status` - ç²å–ç‹€æ…‹

## ä½¿ç”¨ç¯„ä¾‹

```python
import requests

# åˆå§‹åŒ–PGCå¤¾çˆª
response = requests.post('http://localhost:5000/gripper/pgc/initialize', 
                        json={'mode': 1})

# è¨­å®šåŠ›å€¼å’Œä½ç½®
requests.post('http://localhost:5000/gripper/pgc/force', 
              json={'force': 50})
requests.post('http://localhost:5000/gripper/pgc/position', 
              json={'position': 500})
```

## é…ç½®èªªæ˜

ä¿®æ”¹ `config.py` ä¾†èª¿æ•´ï¼š
- RS485é€£æ¥åƒæ•¸
- ä¼ºæœå™¨è¨­å®š
- è¨­å‚™é…ç½®
- æ—¥èªŒè¨­å®š

## æ•…éšœæ’é™¤

1. **ç„¡æ³•é€£æ¥RS485**: æª¢æŸ¥COMå£æ˜¯å¦æ­£ç¢ºï¼Œæ˜¯å¦æœ‰å…¶ä»–ç¨‹åºä½”ç”¨
2. **å¤¢è¨­å‚™ç„¡å›æ‡‰**: ç¢ºèªè¨­å‚™IDå’Œæ³¢ç‰¹ç‡è¨­å®šæ­£ç¢º
3. **APIè«‹æ±‚å¤±æ•—**: æª¢æŸ¥Gatewayæ˜¯å¦æ­£å¸¸é‹è¡Œï¼Œç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸

## é–‹ç™¼èªªæ˜

é€™å€‹ç³»çµ±æ¡ç”¨æ¨¡çµ„åŒ–è¨­è¨ˆï¼Œæ–¹ä¾¿æ“´å±•æ–°çš„è¨­å‚™é¡å‹ã€‚æ·»åŠ æ–°è¨­å‚™æ™‚ï¼š

1. åœ¨ `config.py` ä¸­æ·»åŠ è¨­å‚™é…ç½®
2. åœ¨ `RS485Gateway.py` ä¸­å¯¦ä½œè¨­å‚™ç‰¹å®šåŠŸèƒ½
3. æ›´æ–°APIè·¯ç”±å’Œæ–‡æª”

## æˆæ¬Š

æ­¤å°ˆæ¡ˆåƒ…ä¾›å…§éƒ¨ä½¿ç”¨ï¼Œè«‹å‹¿å¤–å‚³ã€‚