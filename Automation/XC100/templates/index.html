<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XC100 æ»‘å°æ§åˆ¶å™¨ - Enhanced Web UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        /* iOSé¢¨æ ¼Toggleé–‹é—œ */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }
        
        .toggle-label {
            font-weight: 600;
            color: #495057;
            font-size: 1.1rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input:checked + .slider {
            background-color: #007AFF;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* è¡¨å–®å…ƒç´  */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            min-width: 120px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #34C759, #30D158);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #FF3B30, #FF2D92);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FF9500, #FFCC02);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.4);
        }
        
        .btn-secondary {
            background: #8E8E93;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #6D6D70;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        
        .status-item {
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #dee2e6;
        }
        
        .status-item.ready {
            border-left-color: #34C759;
            background: rgba(52, 199, 89, 0.1);
        }
        
        .status-item.running {
            border-left-color: #FF9500;
            background: rgba(255, 149, 0, 0.1);
        }
        
        .status-item.alarm {
            border-left-color: #FF3B30;
            background: rgba(255, 59, 48, 0.1);
        }
        
        .status-item.initialized {
            border-left-color: #007AFF;
            background: rgba(0, 122, 255, 0.1);
        }
        
        .status-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #8E8E93;
            margin-bottom: 4px;
        }
        
        .status-value {
            font-size: 16px;
            font-weight: 600;
            color: #1D1D1F;
        }
        
        /* é€£ç·šç‹€æ…‹ */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .connection-status.connected {
            background: rgba(52, 199, 89, 0.2);
            color: #34C759;
        }
        
        .connection-status.disconnected {
            background: rgba(255, 59, 48, 0.2);
            color: #FF3B30;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        /* è¼¸å…¥ç¾¤çµ„ */
        .input-group {
            display: flex;
            gap: 12px;
            align-items: end;
        }
        
        .input-group .form-control {
            flex: 1;
        }
        
        /* æ¡æ‰‹æ©Ÿåˆ¶è³‡è¨Š */
        .handshake-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .handshake-info h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }
        
        .handshake-info ul {
            margin: 10px 0;
            padding-left: 20px;
            line-height: 1.6;
            color: #0c5460;
        }
        
        /* çµ±è¨ˆè³‡è¨Š */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background: #f1f3f4;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #007AFF;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        /* å‹•ç•«æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* é€šçŸ¥æ¨£å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #34C759, #30D158);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #FF3B30, #FF2D92);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #FF9500, #FFCC02);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›ï¸ XC100 æ»‘å°æ§åˆ¶å™¨</h1>
            <p>Enhanced Modbus TCP æ§åˆ¶å”è­° | æ¡æ‰‹æ©Ÿåˆ¶ | ç‹€æ…‹æ©Ÿé€šä¿¡</p>
        </div>
        
        <div class="grid">
            <!-- é€£ç·šæ§åˆ¶å€åŸŸ -->
            <div class="card fade-in">
                <div class="card-title">
                    ğŸ”— é€£ç·šè¨­å®š
                    <div style="margin-left: auto;">
                        <span id="connectionStatus" class="connection-status disconnected">
                            <span class="status-dot"></span>
                            æœªé€£ç·š
                        </span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ä¸²åˆ—åŸ </label>
                    <select id="portSelect" class="form-control">
                        <option value="">æƒæä¸­...</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">é®‘ç‡</label>
                        <select id="baudrateSelect" class="form-control">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200" selected>115200</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç«™è™Ÿ</label>
                        <input type="number" id="stationId" class="form-control" value="2" min="1" max="247">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="scanBtn" class="btn btn-secondary">ğŸ” é‡æ–°æƒæ</button>
                    <button id="connectBtn" class="btn btn-primary">ğŸ”— é€£ç·š</button>
                    <button id="initializeBtn" class="btn btn-success">âš¡ åˆå§‹åŒ–</button>
                </div>
            </div>
            
            <!-- å¤–éƒ¨æ§åˆ¶æ¨¡å¼åˆ‡æ› -->
            <div class="card fade-in">
                <div class="card-title">âš™ï¸ æ§åˆ¶æ¨¡å¼</div>
                
                <div class="toggle-container">
                    <span class="toggle-label">å¤–éƒ¨æ§åˆ¶æ¨¡å¼</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="externalControlToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div id="controlModeInfo">
                    <p><strong>æ‰‹å‹•æ§åˆ¶æ¨¡å¼ï¼š</strong>å¯ç›´æ¥æ“ä½œæ‰€æœ‰æ§åˆ¶åŠŸèƒ½</p>
                </div>
            </div>
            
            <!-- ç³»çµ±çµ±è¨ˆ -->
            <div class="card fade-in">
                <div class="card-title">ğŸ“Š ç³»çµ±çµ±è¨ˆ</div>
                
                <div class="stats-container">
                    <div class="stat-item">
                        <div class="stat-value" id="commandsSent">0</div>
                        <div class="stat-label">å·²é€æŒ‡ä»¤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="successfulCommands">0</div>
                        <div class="stat-label">æˆåŠŸæŒ‡ä»¤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="connectionErrors">0</div>
                        <div class="stat-label">é€£ç·šéŒ¯èª¤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="uptime">00:00:00</div>
                        <div class="stat-label">é‹è¡Œæ™‚é–“</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¨­å‚™ç‹€æ…‹é¡¯ç¤ºå€åŸŸ -->
        <div class="card fade-in">
            <div class="card-title">ğŸ“Š è¨­å‚™ç‹€æ…‹</div>
            
            <div class="status-grid">
                <div class="status-item" id="readyStatus">
                    <div class="status-label">Ready ç‹€æ…‹</div>
                    <div class="status-value" id="readyValue">æœªçŸ¥</div>
                </div>
                <div class="status-item" id="runningStatus">
                    <div class="status-label">Running ç‹€æ…‹</div>
                    <div class="status-value" id="runningValue">æœªçŸ¥</div>
                </div>
                <div class="status-item" id="alarmStatus">
                    <div class="status-label">Alarm ç‹€æ…‹</div>
                    <div class="status-value" id="alarmValue">æœªçŸ¥</div>
                </div>
                <div class="status-item" id="initStatus">
                    <div class="status-label">Initialized ç‹€æ…‹</div>
                    <div class="status-value" id="initValue">æœªçŸ¥</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ç›®å‰ä½ç½®</div>
                    <div class="status-value" id="positionValue">0.00 mm</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ä¼ºæœç‹€æ…‹</div>
                    <div class="status-value" id="servoValue">æœªé€£ç·š</div>
                </div>
            </div>
        </div>
        
        <div class="grid-3">
            <!-- å¤–éƒ¨æ§åˆ¶å€åŸŸ (æ¡æ‰‹æ©Ÿåˆ¶) -->
            <div class="card fade-in" id="externalControlCard" style="display: none;">
                <div class="card-title">ğŸ¤– å¤–éƒ¨æ§åˆ¶ (æ¡æ‰‹æ©Ÿåˆ¶)</div>
                
                <div class="form-group">
                    <label class="form-label">ç›®æ¨™ä½ç½® (mm)</label>
                    <div class="input-group">
                        <input type="number" id="handshakePosition" class="form-control" step="0.01" placeholder="è¼¸å…¥ç›®æ¨™ä½ç½®">
                        <button id="handshakeMoveBtn" class="btn btn-primary">ç§»å‹•</button>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="handshakeHomeBtn" class="btn btn-warning">ğŸ  åŸé»è³¦æ­¸</button>
                    <button id="handshakeClearBtn" class="btn btn-secondary">ğŸ§¹ æ¸…é™¤</button>
                    <button id="handshakeInitBtn" class="btn btn-success">âš¡ é‡æ–°åˆå§‹åŒ–</button>
                </div>
                
                <div class="handshake-info">
                    <h4>ğŸ¤ æ¡æ‰‹æ©Ÿåˆ¶å”è­°</h4>
                    <ul>
                        <li><strong>æ§åˆ¶æš«å­˜å™¨ (500H)ï¼š</strong>0=æ¸…é™¤, 8=ç§»å‹•, 16=åŸé»è³¦æ­¸, 32=åˆå§‹åŒ–</li>
                        <li><strong>åƒæ•¸æš«å­˜å™¨ (501H-502H)ï¼š</strong>32ä½å…ƒä½ç½® (1æ•¸å€¼=0.01mm)</li>
                        <li><strong>ç‹€æ…‹æš«å­˜å™¨ (503H)ï¼š</strong>Bit0=Ready, Bit1=Running, Bit2=Alarm, Bit3=Init</li>
                        <li><strong>æ¡æ‰‹æµç¨‹ï¼š</strong>æª¢æŸ¥Readyâ†’é€å‡ºæŒ‡ä»¤â†’ç­‰å¾…å®Œæˆâ†’Readyæ¢å¾©</li>
                    </ul>
                </div>
            </div>
            
            <!-- æ‰‹å‹•æ§åˆ¶å€åŸŸ -->
            <div class="card fade-in" id="manualControlCard">
                <div class="card-title">ğŸ® æ‰‹å‹•æ§åˆ¶</div>
                
                <div class="form-group">
                    <label class="form-label">ç›¸å°ç§»å‹• (mm)</label>
                    <div class="input-group">
                        <input type="number" id="relativeMove" class="form-control" step="0.01" placeholder="è¼¸å…¥ç§»å‹•é‡">
                        <button id="relativeMoveBtn" class="btn btn-primary">ç›¸å°ç§»å‹•</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">çµ•å°ç§»å‹• (mm)</label>
                    <div class="input-group">
                        <input type="number" id="absoluteMove" class="form-control" step="0.01" placeholder="è¼¸å…¥ç›®æ¨™ä½ç½®">
                        <button id="absoluteMoveBtn" class="btn btn-primary">çµ•å°ç§»å‹•</button>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="manualHomeBtn" class="btn btn-warning">ğŸ  åŸé»è³¦æ­¸</button>
                    <button id="manualClearBtn" class="btn btn-secondary">ğŸ§¹ æ¸…é™¤æ§åˆ¶</button>
                </div>
                
                <div class="btn-group" style="margin-top: 12px;">
                    <button id="servoOnBtn" class="btn btn-success">ä¼ºæœ ON</button>
                    <button id="servoOffBtn" class="btn btn-secondary">ä¼ºæœ OFF</button>
                </div>
                
                <div class="btn-group" style="margin-top: 12px;">
                    <button id="emergencyStopBtn" class="btn btn-danger" style="width: 100%; font-size: 18px;">ğŸš¨ ç·Šæ€¥åœæ­¢</button>
                </div>
            </div>
            
            <!-- å¿«é€Ÿç§»å‹•é è¨­ä½ç½® -->
            <div class="card fade-in">
                <div class="card-title">ğŸ¯ å¿«é€Ÿç§»å‹•</div>
                
                <div class="btn-group" style="flex-direction: column;">
                    <button id="moveToZeroBtn" class="btn btn-primary">ç§»å‹•åˆ° 0mm</button>
                    <button id="moveTo10Btn" class="btn btn-primary">ç§»å‹•åˆ° 10mm</button>
                    <button id="moveTo25Btn" class="btn btn-primary">ç§»å‹•åˆ° 25mm</button>
                    <button id="moveTo50Btn" class="btn btn-primary">ç§»å‹•åˆ° 50mm</button>
                </div>
                
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">ç§»å‹•åºåˆ— (mm, é€—è™Ÿåˆ†éš”)</label>
                    <input type="text" id="sequenceInput" class="form-control" placeholder="ä¾‹: 0,10,25,50,0">
                    <button id="executeSequenceBtn" class="btn btn-warning" style="margin-top: 8px; width: 100%;">åŸ·è¡Œåºåˆ—</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notification" class="notification"></div>
    
    <script>
        // å…¨åŸŸè®Šæ•¸
        let connected = false;
        let externalControlMode = false;
        let statusUpdateInterval;
        
        // DOMå…ƒç´ 
        const elements = {
            // é€£ç·šæ§åˆ¶
            portSelect: document.getElementById('portSelect'),
            baudrateSelect: document.getElementById('baudrateSelect'),
            stationId: document.getElementById('stationId'),
            scanBtn: document.getElementById('scanBtn'),
            connectBtn: document.getElementById('connectBtn'),
            initializeBtn: document.getElementById('initializeBtn'),
            connectionStatus: document.getElementById('connectionStatus'),
            
            // å¤–éƒ¨æ§åˆ¶æ¨¡å¼
            externalControlToggle: document.getElementById('externalControlToggle'),
            externalControlCard: document.getElementById('externalControlCard'),
            manualControlCard: document.getElementById('manualControlCard'),
            controlModeInfo: document.getElementById('controlModeInfo'),
            
            // æ¡æ‰‹æ©Ÿåˆ¶æ§åˆ¶
            handshakePosition: document.getElementById('handshakePosition'),
            handshakeMoveBtn: document.getElementById('handshakeMoveBtn'),
            handshakeHomeBtn: document.getElementById('handshakeHomeBtn'),
            handshakeClearBtn: document.getElementById('handshakeClearBtn'),
            handshakeInitBtn: document.getElementById('handshakeInitBtn'),
            
            // æ‰‹å‹•æ§åˆ¶
            relativeMove: document.getElementById('relativeMove'),
            relativeMoveBtn: document.getElementById('relativeMoveBtn'),
            absoluteMove: document.getElementById('absoluteMove'),
            absoluteMoveBtn: document.getElementById('absoluteMoveBtn'),
            manualHomeBtn: document.getElementById('manualHomeBtn'),
            manualClearBtn: document.getElementById('manualClearBtn'),
            servoOnBtn: document.getElementById('servoOnBtn'),
            servoOffBtn: document.getElementById('servoOffBtn'),
            emergencyStopBtn: document.getElementById('emergencyStopBtn'),
            
            // å¿«é€Ÿç§»å‹•
            moveToZeroBtn: document.getElementById('moveToZeroBtn'),
            moveTo10Btn: document.getElementById('moveTo10Btn'),
            moveTo25Btn: document.getElementById('moveTo25Btn'),
            moveTo50Btn: document.getElementById('moveTo50Btn'),
            sequenceInput: document.getElementById('sequenceInput'),
            executeSequenceBtn: document.getElementById('executeSequenceBtn'),
            
            // ç‹€æ…‹é¡¯ç¤º
            readyStatus: document.getElementById('readyStatus'),
            readyValue: document.getElementById('readyValue'),
            runningStatus: document.getElementById('runningStatus'),
            runningValue: document.getElementById('runningValue'),
            alarmStatus: document.getElementById('alarmStatus'),
            alarmValue: document.getElementById('alarmValue'),
            initStatus: document.getElementById('initStatus'),
            initValue: document.getElementById('initValue'),
            positionValue: document.getElementById('positionValue'),
            servoValue: document.getElementById('servoValue'),
            
            // çµ±è¨ˆ
            commandsSent: document.getElementById('commandsSent'),
            successfulCommands: document.getElementById('successfulCommands'),
            connectionErrors: document.getElementById('connectionErrors'),
            uptime: document.getElementById('uptime'),
            
            // é€šçŸ¥
            notification: document.getElementById('notification')
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            scanPorts();
            setupEventListeners();
            startStatusUpdates();
        });
        
        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            elements.scanBtn.addEventListener('click', scanPorts);
            elements.connectBtn.addEventListener('click', toggleConnection);
            elements.initializeBtn.addEventListener('click', initializeDevice);
            elements.externalControlToggle.addEventListener('change', toggleExternalControl);
            
            // æ¡æ‰‹æ©Ÿåˆ¶æ§åˆ¶
            elements.handshakeMoveBtn.addEventListener('click', handshakeMove);
            elements.handshakeHomeBtn.addEventListener('click', handshakeHome);
            elements.handshakeClearBtn.addEventListener('click', handshakeClear);
            elements.handshakeInitBtn.addEventListener('click', handshakeInitialize);
            
            // æ‰‹å‹•æ§åˆ¶
            elements.relativeMoveBtn.addEventListener('click', () => manualMove('relative'));
            elements.absoluteMoveBtn.addEventListener('click', () => manualMove('absolute'));
            elements.manualHomeBtn.addEventListener('click', manualHome);
            elements.manualClearBtn.addEventListener('click', manualClear);
            elements.servoOnBtn.addEventListener('click', () => servoControl('on'));
            elements.servoOffBtn.addEventListener('click', () => servoControl('off'));
            elements.emergencyStopBtn.addEventListener('click', emergencyStop);
            
            // å¿«é€Ÿç§»å‹•
            elements.moveToZeroBtn.addEventListener('click', () => quickMove(0));
            elements.moveTo10Btn.addEventListener('click', () => quickMove(10));
            elements.moveTo25Btn.addEventListener('click', () => quickMove(25));
            elements.moveTo50Btn.addEventListener('click', () => quickMove(50));
            elements.executeSequenceBtn.addEventListener('click', executeSequence);
        }
        
        // æƒæCOMå£
        async function scanPorts() {
            try {
                const response = await fetch('/api/scan_ports');
                const data = await response.json();
                
                elements.portSelect.innerHTML = '';
                if (data.ports.length === 0) {
                    elements.portSelect.innerHTML = '<option value="">æœªæ‰¾åˆ°å¯ç”¨çš„COMå£</option>';
                } else {
                    data.ports.forEach(port => {
                        const option = document.createElement('option');
                        option.value = port.device;
                        option.textContent = `${port.device} - ${port.description}`;
                        elements.portSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('æƒæCOMå£å¤±æ•—:', error);
                showNotification('æƒæCOMå£å¤±æ•—', 'error');
            }
        }
        
        // åˆ‡æ›é€£ç·š
        async function toggleConnection() {
            if (connected) {
                await disconnect();
            } else {
                await connect();
            }
        }
        
        // é€£ç·š
        async function connect() {
            const port = elements.portSelect.value;
            const baudrate = elements.baudrateSelect.value;
            const stationId = elements.stationId.value;
            
            if (!port) {
                showNotification('è«‹é¸æ“‡æœ‰æ•ˆçš„COMå£', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port, baudrate, station_id: stationId })
                });
                
                const data = await response.json();
                if (data.success) {
                    connected = true;
                    updateConnectionUI();
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                console.error('é€£ç·šå¤±æ•—:', error);
                showNotification('é€£ç·šå¤±æ•—', 'error');
            }
        }
        
        // æ–·ç·š
        async function disconnect() {
            try {
                await fetch('/api/disconnect', { method: 'POST' });
                connected = false;
                updateConnectionUI();
                showNotification('å·²æ–·é–‹é€£ç·š', 'warning');
            } catch (error) {
                console.error('æ–·ç·šå¤±æ•—:', error);
            }
        }
        
        // åˆå§‹åŒ–è¨­å‚™
        async function initializeDevice() {
            try {
                const response = await fetch('/api/initialize', { method: 'POST' });
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                showNotification('åˆå§‹åŒ–å¤±æ•—', 'error');
            }
        }
        
        // æ›´æ–°é€£ç·šUI
        function updateConnectionUI() {
            if (connected) {
                elements.connectBtn.textContent = 'ğŸ”Œ æ–·é–‹é€£ç·š';
                elements.connectBtn.className = 'btn btn-danger';
                elements.connectionStatus.className = 'connection-status connected';
                elements.connectionStatus.innerHTML = '<span class="status-dot"></span>å·²é€£ç·š';
            } else {
                elements.connectBtn.textContent = 'ğŸ”— é€£ç·š';
                elements.connectBtn.className = 'btn btn-primary';
                elements.connectionStatus.className = 'connection-status disconnected';
                elements.connectionStatus.innerHTML = '<span class="status-dot"></span>æœªé€£ç·š';
            }
        }
        
        // åˆ‡æ›å¤–éƒ¨æ§åˆ¶æ¨¡å¼
        async function toggleExternalControl() {
            externalControlMode = elements.externalControlToggle.checked;
            
            try {
                const response = await fetch('/api/external_control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: externalControlMode })
                });
                
                const data = await response.json();
                if (data.success) {
                    updateControlModeUI();
                    showNotification(data.message, 'success');
                }
            } catch (error) {
                console.error('åˆ‡æ›æ§åˆ¶æ¨¡å¼å¤±æ•—:', error);
                showNotification('åˆ‡æ›æ§åˆ¶æ¨¡å¼å¤±æ•—', 'error');
            }
        }
        
        // æ›´æ–°æ§åˆ¶æ¨¡å¼UI
        function updateControlModeUI() {
            if (externalControlMode) {
                elements.externalControlCard.style.display = 'block';
                elements.manualControlCard.style.opacity = '0.6';
                elements.controlModeInfo.innerHTML = '<p><strong>å¤–éƒ¨æ§åˆ¶æ¨¡å¼ï¼š</strong>é€éæ¡æ‰‹æ©Ÿåˆ¶é€²è¡Œè‡ªå‹•åŒ–æ§åˆ¶</p>';
            } else {
                elements.externalControlCard.style.display = 'none';
                elements.manualControlCard.style.opacity = '1';
                elements.controlModeInfo.innerHTML = '<p><strong>æ‰‹å‹•æ§åˆ¶æ¨¡å¼ï¼š</strong>å¯ç›´æ¥æ“ä½œæ‰€æœ‰æ§åˆ¶åŠŸèƒ½</p>';
            }
        }
        
        // === æ¡æ‰‹æ©Ÿåˆ¶æ§åˆ¶å‡½æ•¸ ===
        
        async function handshakeMove() {
            const position = parseFloat(elements.handshakePosition.value);
            if (isNaN(position)) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„ä½ç½®æ•¸å€¼', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/handshake/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ position })
                });
                
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('æ¡æ‰‹ç§»å‹•å¤±æ•—:', error);
                showNotification('æ¡æ‰‹ç§»å‹•å¤±æ•—', 'error');
            }
        }
        
        async function handshakeHome() {
            try {
                const response = await fetch('/api/handshake/home', { method: 'POST' });
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('æ¡æ‰‹åŸé»è³¦æ­¸å¤±æ•—:', error);
                showNotification('æ¡æ‰‹åŸé»è³¦æ­¸å¤±æ•—', 'error');
            }
        }
        
        async function handshakeClear() {
            try {
                const response = await fetch('/api/handshake/clear', { method: 'POST' });
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('æ¡æ‰‹æ¸…é™¤å¤±æ•—:', error);
                showNotification('æ¡æ‰‹æ¸…é™¤å¤±æ•—', 'error');
            }
        }
        
        async function handshakeInitialize() {
            try {
                const response = await fetch('/api/handshake/initialize', { method: 'POST' });
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('æ¡æ‰‹åˆå§‹åŒ–å¤±æ•—:', error);
                showNotification('æ¡æ‰‹åˆå§‹åŒ–å¤±æ•—', 'error');
            }
        }
        
        // === æ‰‹å‹•æ§åˆ¶å‡½æ•¸ ===
        
        async function manualMove(type) {
            if (externalControlMode) {
                showNotification('å¤–éƒ¨æ§åˆ¶æƒ…æ³ä¸‹ç„¡æ³•æ‰‹å‹•æ§åˆ¶', 'warning');
                return;
            }
            
            const input = type === 'relative' ? elements.relativeMove : elements.absoluteMove;
            const value = parseFloat(input.value);
            
            if (isNaN(value)) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/manual/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, value })
                });
                
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('æ‰‹å‹•ç§»å‹•å¤±æ•—:', error);
                showNotification('æ‰‹å‹•ç§»å‹•å¤±æ•—', 'error');
            }
        }
        
        async function manualHome() {
            if (externalControlMode) {
                showNotification('å¤–éƒ¨æ§åˆ¶æƒ…æ³ä¸‹ç„¡æ³•æ‰‹å‹•æ§åˆ¶', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/manual/home', { method: 'POST' });
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('æ‰‹å‹•åŸé»è³¦æ­¸å¤±æ•—:', error);
                showNotification('æ‰‹å‹•åŸé»è³¦æ­¸å¤±æ•—', 'error');
            }
        }
        
        async function manualClear() {
            if (externalControlMode) {
                showNotification('å¤–éƒ¨æ§åˆ¶æƒ…æ³ä¸‹ç„¡æ³•æ‰‹å‹•æ§åˆ¶', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/manual/clear', { method: 'POST' });
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('æ‰‹å‹•æ¸…é™¤å¤±æ•—:', error);
                showNotification('æ‰‹å‹•æ¸…é™¤å¤±æ•—', 'error');
            }
        }
        
        async function servoControl(state) {
            try {
                const response = await fetch('/api/servo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ state })
                });
                
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('ä¼ºæœæ§åˆ¶å¤±æ•—:', error);
                showNotification('ä¼ºæœæ§åˆ¶å¤±æ•—', 'error');
            }
        }
        
        async function emergencyStop() {
            try {
                const response = await fetch('/api/emergency_stop', { method: 'POST' });
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('ç·Šæ€¥åœæ­¢å¤±æ•—:', error);
                showNotification('ç·Šæ€¥åœæ­¢å¤±æ•—', 'error');
            }
        }
        
        // === å¿«é€Ÿç§»å‹•å‡½æ•¸ ===
        
        async function quickMove(position) {
            if (externalControlMode) {
                // ä½¿ç”¨æ¡æ‰‹æ©Ÿåˆ¶
                elements.handshakePosition.value = position;
                await handshakeMove();
            } else {
                // ä½¿ç”¨æ‰‹å‹•æ§åˆ¶
                elements.absoluteMove.value = position;
                await manualMove('absolute');
            }
        }
        
        async function executeSequence() {
            const sequenceText = elements.sequenceInput.value.trim();
            if (!sequenceText) {
                showNotification('è«‹è¼¸å…¥ç§»å‹•åºåˆ—', 'error');
                return;
            }
            
            try {
                const positions = sequenceText.split(',').map(pos => parseFloat(pos.trim()));
                
                // æª¢æŸ¥æ‰€æœ‰ä½ç½®æ˜¯å¦æœ‰æ•ˆ
                if (positions.some(pos => isNaN(pos))) {
                    showNotification('åºåˆ—ä¸­åŒ…å«ç„¡æ•ˆçš„æ•¸å€¼', 'error');
                    return;
                }
                
                const response = await fetch('/api/move_sequence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ positions, wait_each: true })
                });
                
                const data = await response.json();
                showNotification(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('åŸ·è¡Œåºåˆ—å¤±æ•—:', error);
                showNotification('åŸ·è¡Œåºåˆ—å¤±æ•—', 'error');
            }
        }
        
        // é–‹å§‹ç‹€æ…‹æ›´æ–°
        function startStatusUpdates() {
            statusUpdateInterval = setInterval(updateStatus, 1000);
        }
        
        // æ›´æ–°ç‹€æ…‹
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                connected = data.connected;
                externalControlMode = data.external_control;
                
                updateConnectionUI();
                updateStatusDisplay(data.device_status, data.handshake_status);
                updateStatsDisplay(data.stats);
                
                // åŒæ­¥å¤–éƒ¨æ§åˆ¶é–‹é—œ
                if (elements.externalControlToggle.checked !== externalControlMode) {
                    elements.externalControlToggle.checked = externalControlMode;
                    updateControlModeUI();
                }
                
            } catch (error) {
                console.error('ç²å–ç‹€æ…‹å¤±æ•—:', error);
            }
        }
        
        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateStatusDisplay(deviceStatus, handshakeStatus) {
            // æ›´æ–°æ¡æ‰‹ç‹€æ…‹
            if (handshakeStatus) {
                updateStatusItem(elements.readyStatus, elements.readyValue, handshakeStatus.ready, 'ready');
                updateStatusItem(elements.runningStatus, elements.runningValue, handshakeStatus.running, 'running');
                updateStatusItem(elements.alarmStatus, elements.alarmValue, handshakeStatus.alarm, 'alarm');
                updateStatusItem(elements.initStatus, elements.initValue, handshakeStatus.initialized, 'initialized');
            }
            
            // æ›´æ–°è¨­å‚™ç‹€æ…‹
            if (deviceStatus) {
                elements.positionValue.textContent = `${deviceStatus.current_position?.toFixed(2) || 0.00} mm`;
                elements.servoValue.textContent = deviceStatus.servo_status ? 'ON' : 'OFF';
            }
        }
        
        // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
        function updateStatsDisplay(stats) {
            if (stats) {
                elements.commandsSent.textContent = stats.commands_sent || 0;
                elements.successfulCommands.textContent = stats.successful_commands || 0;
                elements.connectionErrors.textContent = stats.connection_errors || 0;
                elements.uptime.textContent = stats.uptime_formatted || '00:00:00';
            }
        }
        
        // æ›´æ–°å–®å€‹ç‹€æ…‹é …ç›®
        function updateStatusItem(element, valueElement, value, type) {
            const statusText = value ? 'ON' : 'OFF';
            const statusClass = value ? type : '';
            
            valueElement.textContent = statusText;
            element.className = `status-item ${statusClass}`;
        }
        
        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            elements.notification.textContent = message;
            elements.notification.className = `notification ${type}`;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>